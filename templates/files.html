<!-- templates/index.html -->
{% extends 'base.html' %}

{% block title %}CLU (Comic Library Utilities){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/files.css') }}">
{% endblock %}

{% block content %}

<div class="container-lg">
  <h2 class="text-primary-emphasis">File Manager</h2>

  <!-- Progress indicator -->
  <div class="row p-3" id="progress-container" style="display: none;">
    <div class="col-12">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0"><i class="bi bi-hourglass-split me-2"></i>Processing Progress</h5>
          <button type="button" class="btn-close btn-close-white" onclick="hideProgressIndicator()"
            aria-label="Close"></button>
        </div>
        <div class="card-body">
          <div class="progress mb-3" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
              style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              0%
            </div>
          </div>
          <div id="progress-text" class="text-muted">Initializing...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selection Count Badge -->
  <div id="selectionBadge" class="selection-badge">
    <i class="bi bi-check2-square badge-icon"></i>
    <span id="selectionCount">0 selected</span>
    <span class="badge-hint">Drag to move â€¢ Right-click for options</span>
  </div>

  <div class="row">
    <!-- Source Panel -->
    <div class="col-md-6">
      <h3>Source</h3>
      <!-- Button group for switching between Library, Downloads and Recent Files -->
      <div class="btn-group mb-2" role="group" aria-label="View Options">
        <!-- Library Dropdown -->
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button"
                  id="sourceLibraryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-folder2-open me-1"></i><span id="sourceLibraryName">Library</span>
          </button>
          <ul class="dropdown-menu" id="sourceLibraryMenu">
            <!-- Populated by JavaScript -->
          </ul>
        </div>
        <button type="button" id="btnDownloads" class="btn btn-outline-primary"
          onclick="loadDownloads('{{ target_dir }}', 'source');" data-bs-toggle="button">Downloads</button>
        <button type="button" id="btnRecentFiles" class="btn btn-outline-primary" onclick="loadRecentFiles('source');"
          data-bs-toggle="button">Recent Files</button>
      </div>
      <!-- Filter buttons for source panel -->
      <div id="source-directory-filter" class="mb-2">
        <div class="btn-group d-grid grid-filter-buttons" role="group" aria-label="Directory Filter">
          <!-- Dynamically inserted buttons go here -->
        </div>
        <div id="source-directory-search-row" class="pt-2"></div>
        <div id="source-directory-rename-row" class="pt-2"></div>
      </div>
      <nav aria-label="breadcrumb">
        <ol id="source-path-display" class="breadcrumb">
          <li class="breadcrumb-item active">Loading...</li>
        </ol>
      </nav>
      <ul id="source-list" class="list-group drop-target"></ul>
    </div>
    <!-- Destination Panel -->
    <div class="col-md-6">
      <h3>Destination</h3>
      <!-- Library Dropdown and Action Buttons -->
      <div class="d-flex gap-2 mb-2">
        <!-- Library Dropdown -->
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button"
                  id="destLibraryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-folder2-open me-1"></i><span id="destLibraryName">Library</span>
          </button>
          <ul class="dropdown-menu" id="destLibraryMenu">
            <!-- Populated by JavaScript -->
          </ul>
        </div>
        <!-- Action Buttons -->
        <div class="btn-group" role="group" aria-label="Folder Options">
          <button type="button" class="btn btn-outline-primary" onclick="openCreateFolderModal()"><i
              class="bi bi-folder-plus"></i> Create Folder</button>
          <button type="button" class="btn btn-outline-primary" onclick="openSearchModal()"><i class="bi bi-search"></i>
            Search Files</button>
        </div>
      </div>

      <!-- Filter buttons for destination panel -->
      <div id="destination-directory-filter" class="mb-2">
        <div class="btn-group d-grid grid-filter-buttons" role="group" aria-label="Directory Filter">
          <!-- Dynamically inserted buttons go here -->
        </div>
        <div id="destination-directory-search-row" class="pt-2"></div>
        <div id="destination-directory-rename-row" class="pt-2"></div>
      </div>
      <nav aria-label="breadcrumb">
        <ol id="destination-path-display" class="breadcrumb">
          <li class="breadcrumb-item active">Loading...</li>
        </ol>
      </nav>
      <ul id="destination-list" class="list-group drop-target"></ul>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="moveErrorToast" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <strong class="me-auto">Rename Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="moveErrorToastBody">
        Rename failed.
      </div>
    </div>

    <!-- ComicInfo Clear Confirmation Toast -->
    <div id="clearComicInfoConfirmToast" class="toast bg-warning" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-warning">
        <strong class="me-auto">Confirm Delete</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        <p class="mb-2">Are you sure you want to delete ComicInfo.xml? This cannot be undone.</p>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-danger" id="confirmClearComicInfoBtn">Delete</button>
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ComicInfo Clear Success Toast -->
    <div id="clearComicInfoSuccessToast" class="toast bg-success text-white" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="toast-header bg-success text-white">
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ComicInfo.xml has been successfully deleted.
      </div>
    </div>

    <!-- ComicInfo Clear Error Toast -->
    <div id="clearComicInfoErrorToast" class="toast bg-danger text-white" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="clearComicInfoErrorBody">
        Failed to delete ComicInfo.xml.
      </div>
    </div>
  </div>

</div>

<!-- Context Menu for Multi-file Selection -->
<div id="fileContextMenu" class="dropdown-menu" style="display: none; position: absolute; z-index: 1050;">
  <a class="dropdown-item" href="#" id="contextCreateFolder">
    <i class="bi bi-folder-plus me-2"></i>Create Folder with Selection
  </a>
  <a class="dropdown-item" href="#" id="contextCombineFiles">
    <i class="bi bi-collection me-2"></i>Combine Selected Files
  </a>
  <a class="dropdown-item text-danger" href="#" id="contextDeleteFiles">
    <i class="bi bi-trash me-2"></i>Delete Selected Files
  </a>
</div>

<!-- Delete Confirmation Modal (Bootstrap 5.3) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="deleteItemName"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Delete Confirmation Modal -->

<!-- Multi-file Delete Confirmation Modal -->
<div class="modal fade" id="deleteMultipleModal" tabindex="-1" aria-labelledby="deleteMultipleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteMultipleModalLabel">Confirm Delete Multiple Files</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="deleteMultipleCount"></strong> files?</p>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>This action cannot be undone.
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
          <ul id="deleteMultipleFileList" class="list-group">
            <!-- File names will be populated here -->
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteMultipleBtn">Delete All</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Multi-file Delete Confirmation Modal -->

<!-- Folder Name Prompt Modal for Mixed Series -->
<div class="modal fade" id="folderNamePromptModal" tabindex="-1" aria-labelledby="folderNamePromptModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="folderNamePromptModalLabel">Enter Folder Name</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <span id="folderPromptMessage">Selected files have different series names. Please enter a folder name.</span>
        </div>
        <div class="mb-3">
          <label for="customFolderName" class="form-label">Folder Name</label>
          <input type="text" class="form-control" id="customFolderName" placeholder="Enter folder name"
            autocomplete="off" />
        </div>
        <div id="selectedFilesList" style="max-height: 200px; overflow-y: auto;">
          <h6 class="text-muted small">Selected files:</h6>
          <ul id="selectedFilesListItems" class="list-group list-group-flush small">
            <!-- File names will be populated here -->
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCustomFolderBtn">Create Folder</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Folder Name Prompt Modal -->

<!-- Combine Files Modal -->
<div class="modal fade" id="combineFilesModal" tabindex="-1" aria-labelledby="combineFilesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="combineFilesModalLabel"><i class="bi bi-collection me-2"></i>Combine Selected Files</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Enter a name for the combined CBZ file:</p>
        <div class="mb-3">
          <label for="combinedFileName" class="form-label">Output Filename</label>
          <input type="text" class="form-control" id="combinedFileName" placeholder="Combined Comic" autocomplete="off">
          <div class="form-text">Files with duplicate names will be suffixed with a, b, c, etc.</div>
        </div>
        <div id="combineFilesList" class="small text-muted" style="max-height: 150px; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCombineFilesBtn">
          <i class="bi bi-collection me-1"></i>Combine
        </button>
      </div>
    </div>
  </div>
</div>
<!-- End of Combine Files Modal -->

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createFolderModalLabel">Create New Folder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="createFolderName" class="form-label">Folder Name</label>
          <input type="text" class="form-control" id="createFolderName" placeholder="Enter folder name" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCreateFolderBtn">Create</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Create Folder Modal -->

<!-- Moving Status Modal -->
<div class="modal fade" id="movingModal" tabindex="-1" aria-labelledby="movingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="movingModalLabel">Moving Items</h5>
        <!-- You can optionally allow closing if desired -->
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
          style="display: none;"></button>
      </div>
      <div class="modal-body">
        <p id="movingStatusText">Preparing to move items...</p>
        <div class="progress">
          <div id="movingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End of Moving Status Modal -->

<!-- CBZ Info Modal -->
<div class="modal fade" id="cbzInfoModal" tabindex="-1" aria-labelledby="cbzInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cbzInfoModalLabel">CBZ Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Navigation buttons row -->
        <div id="cbzNavButtons" class="d-flex justify-content-between mb-3" style="display: none !important;">
          <button type="button" id="cbzPrevBtn" class="btn btn-outline-primary" style="visibility: hidden;">
            <i class="bi bi-arrow-left"></i> Prev
          </button>
          <button type="button" id="cbzNextBtn" class="btn btn-outline-primary" style="visibility: hidden;">
            Next <i class="bi bi-arrow-right"></i>
          </button>
        </div>

        <div id="cbzInfoContent">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading CBZ information...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- End of CBZ Info Modal -->

<!-- Custom Remove Text from Filenames Modal -->
<div class="modal fade" id="customRenameModal" tabindex="-1" aria-labelledby="customRenameModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customRenameModalLabel">Custom Remove Text from Filenames</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="textToRemove" class="form-label">Text to Remove from All Filenames:</label>
          <input type="text" class="form-control" id="textToRemove" placeholder="e.g., ' v1'" autocomplete="off">
          <div class="form-text">
            This text will be removed from all files in the selected directory. File extensions are ignored.
          </div>
        </div>
        <div class="mb-3">
          <div class="alert alert-info">
            <strong>Example:</strong><br>
            Filename: <code>Captain Britain v1 001.cbz</code><br>
            Text to Remove: <code> v1</code><br>
            New Filename: <code>Captain Britain 001.cbz</code>
          </div>
        </div>
        <div id="renamePreview" class="mb-3" style="display: none;">
          <h6>Preview of Changes:</h6>
          <div id="renamePreviewList" class="small text-muted" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="previewRenameBtn"
          onclick="previewCustomRename()">Preview</button>
        <button type="button" class="btn btn-success" id="executeRenameBtn" onclick="executeCustomRename()"
          style="display: none;">Execute Rename</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Custom Rename Modal -->

<!-- Replace Text in Filenames Modal -->
<div class="modal fade" id="replaceTextModal" tabindex="-1" aria-labelledby="replaceTextModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replaceTextModalLabel">Replace Text in Filenames</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="textToReplace" class="form-label">Text to Replace:</label>
          <input type="text" class="form-control" id="textToReplace" placeholder="e.g., 'v1'" autocomplete="off">
          <div class="form-text">
            This text will be found in all filenames in the selected directory.
          </div>
        </div>
        <div class="mb-3">
          <label for="replacementText" class="form-label">Replacement Text:</label>
          <input type="text" class="form-control" id="replacementText" placeholder="e.g., 'Volume 1'"
            autocomplete="off">
          <div class="form-text">
            The text above will be replaced with this text. Leave blank to remove the text.
          </div>
        </div>
        <div class="mb-3">
          <div class="alert alert-info">
            <strong>Example:</strong><br>
            Filename: <code>Captain Britain v1 001.cbz</code><br>
            Text to Replace: <code>v1</code><br>
            Replacement Text: <code>Volume 1</code><br>
            New Filename: <code>Captain Britain Volume 1 001.cbz</code>
          </div>
        </div>
        <div id="replacePreview" class="mb-3" style="display: none;">
          <h6>Preview of Changes:</h6>
          <div id="replacePreviewList" class="small text-muted" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="previewReplaceBtn"
          onclick="previewReplaceText()">Preview</button>
        <button type="button" class="btn btn-success" id="executeReplaceBtn" onclick="executeReplaceText()"
          style="display: none;">Execute Replace</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Replace Text Modal -->

<!-- Rename Files Modal -->
<div class="modal fade" id="renameFilesModal" tabindex="-1" aria-labelledby="renameFilesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameFilesModalLabel">Rename Files with New Pattern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="newSeriesName" class="form-label">New Series Name:</label>
          <input type="text" class="form-control" id="newSeriesName" placeholder="e.g., 'Saga of the Swamp Thing'"
            autocomplete="off">
          <div class="form-text">
            This will replace the series name while preserving issue numbers and years. File extensions will remain
            unchanged.
          </div>
        </div>
        <div class="mb-3">
          <div class="alert alert-info">
            <strong>Example:</strong><br>
            Original: <code>Swamp Thing 001 (1982).cbz</code><br>
            New Series Name: <code>Saga of the Swamp Thing</code><br>
            Result: <code>Saga of the Swamp Thing 001 (1982).cbz</code>
          </div>
        </div>
        <div id="renameFilesPreview" class="mb-3" style="display: none;">
          <h6>Preview of Changes:</h6>
          <div id="renameFilesPreviewList" class="small text-muted" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="previewRenameFilesBtn"
          onclick="previewRenameFiles()">Preview</button>
        <button type="button" class="btn btn-success" id="executeRenameFilesBtn" onclick="executeRenameFiles()"
          style="display: none;">Execute Rename</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Rename Files Modal -->

<!-- Search Files Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search Files</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="searchQuery" class="form-label">Search Query:</label>
          <div class="input-group">
            <input type="text" class="form-control" id="searchQuery" placeholder="Enter search term..."
              autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" onclick="performSearch()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div class="form-text">
            Search through all files and directories in /data. Results will appear below.
          </div>
        </div>
        <div id="searchResults" class="mt-3" style="display: none;">
          <h6>Search Results for: <span id="currentSearchTerm" class="text-primary"></span></h6>
          <div id="searchResultsList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
        <div id="searchLoading" class="text-center mt-3" style="display: none;">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Searching...</span>
          </div>
          <p class="mt-2">Searching files...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Search Files Modal -->

<!-- GCD Series Selection Modal -->
<div class="modal fade" id="gcdSeriesModal" tabindex="-1" aria-labelledby="gcdSeriesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gcdSeriesModalLabel">Select Correct Series</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p><strong>Parsed from filename:</strong></p>
          <ul class="list-unstyled">
            <li><strong>Series:</strong> <span id="gcdParsedSeries"></span></li>
            <li><strong>Issue:</strong> <span id="gcdParsedIssue"></span></li>
            <li><strong>Year:</strong> <span id="gcdParsedYear"></span></li>
          </ul>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="mb-0"><strong>Please select the correct series from the GCD database:</strong></p>
            <div class="btn-group" role="group" aria-label="Sort options">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="sortBySeries"
                onclick="sortGCDSeries('series')">
                <i class="bi bi-sort-alpha-down me-1"></i>Series
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="sortByYear"
                onclick="sortGCDSeries('year')">
                <i class="bi bi-sort-numeric-down me-1"></i>Year
              </button>
            </div>
          </div>
          <div id="gcdSeriesList" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <!-- Series options will be populated here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
<!-- End of GCD Series Selection Modal -->

<!-- ComicVine Volume Selection Modal -->
<div class="modal fade" id="comicVineVolumeModal" tabindex="-1" aria-labelledby="comicVineVolumeModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="comicVineVolumeModalLabel">Select Correct Volume</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p><strong>Parsed from filename:</strong></p>
          <ul class="list-unstyled">
            <li><strong>Series:</strong> <span id="cvParsedSeries"></span></li>
            <li><strong>Issue:</strong> <span id="cvParsedIssue"></span></li>
            <li><strong>Year:</strong> <span id="cvParsedYear"></span></li>
          </ul>
        </div>
        <div class="mb-3">
          <p class="mb-2"><strong>Please select the correct volume from ComicVine:</strong></p>
          <div id="cvVolumeList" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <!-- Volume options will be populated here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
<!-- End of ComicVine Volume Selection Modal -->

<!-- Rename Confirmation Modal -->
<div class="modal fade" id="renameConfirmModal" tabindex="-1" aria-labelledby="renameConfirmModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameConfirmModalLabel">Rename File?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Current filename:</strong></p>
        <p class="text-muted" id="renameCurrentName"></p>
        <p><strong>Suggested filename:</strong></p>
        <p class="text-success fw-bold" id="renameSuggestedName"></p>
        <p class="text-muted small">The filename will be updated to match the metadata from ComicVine.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Original</button>
        <button type="button" class="btn btn-primary" id="confirmRenameBtn">Rename File</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Rename Confirmation Modal -->

<!-- Edit CBZ Modal -->
<div class="modal fade" id="editCBZModal" tabindex="-1" aria-labelledby="editCBZModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCBZModalLabel">Editing CBZ File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          <!-- Inline editing content (cards) will be dynamically loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveEditBtn" onclick="saveEditedCBZ()">
          <i class="bi bi-floppy2-fill"></i> Save
        </button>
        <form action="/save" method="post" id="editInlineSaveForm" style="display: none;">
          <input type="hidden" name="folder_name" id="editInlineFolderName">
          <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
          <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel" aria-hidden="true"
  data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center bg-dark"
        style="overflow: hidden; position: relative;">
        <div id="cropImageContainer"
          style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
          <img id="cropImage" src="" alt="Image to crop"
            style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
          <div id="cropSelection"
            style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()"
          disabled>Confirm Crop</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Free Form Crop Modal -->
<!-- Missing File Check Results Modal -->
<div class="modal fade" id="missingFileCheckModal" tabindex="-1" aria-labelledby="missingFileCheckModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="missingFileCheckModalLabel">Missing File Check Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="missingFileCheckContent">
          <!-- Summary Section -->
          <div class="alert alert-info mb-3">
            <h6 class="alert-heading mb-2">
              <i class="bi bi-info-circle"></i> Summary
            </h6>
            <p class="mb-0" id="missingFileCheckSummary"></p>
          </div>

          <!-- File Link Section -->
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">
                <i class="bi bi-file-earmark-text"></i> Missing Issues File
              </h6>
              <p class="card-text">
                A detailed list of missing issues has been saved to:
              </p>
              <div class="bg-light p-2 rounded mb-2">
                <code id="missingFileCheckPath"></code>
              </div>
              <a href="#" id="missingFileCheckLink" class="btn btn-sm btn-primary" target="_blank">
                <i class="bi bi-box-arrow-up-right"></i> View File
              </a>
            </div>
          </div>

          <!-- Info Section -->
          <div class="alert alert-secondary mt-3 mb-0">
            <small>
              <i class="bi bi-lightbulb"></i>
              This file will remain in the directory for your reference. You can access it anytime by navigating to the
              folder.
            </small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Missing File Check Results Modal -->

<!-- ComicVine URL Modal -->
<div class="modal fade" id="cvInfoModal" tabindex="-1" aria-labelledby="cvInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cvInfoModalLabel"><i class="bi bi-link-45deg"></i> Add CVINFO</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">Enter the Comic Vine Volume ID for this series. This will be saved as a <code>cvinfo</code> file and used to auto-fetch metadata for comics in this folder.</p>
        <div class="mb-3">
          <label for="cvInfoIdInput" class="form-label">Comic Vine Volume ID <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="cvInfoIdInput" placeholder="167796" required>
          <div class="form-text">Example: https://comicvine.gamespot.com/volume/4050-<strong>167796</strong> - the CV_ID is <strong>167796</strong></div>
        </div>
        <div class="mb-3">
          <label for="metronIdInput" class="form-label">Metron Series ID <span class="text-muted">(optional)</span></label>
          <input type="text" class="form-control" id="metronIdInput" placeholder="12345">
          <div class="form-text">If you have a Metron series ID, enter it here to enable Metron metadata fetching.</div>
        </div>
        <input type="hidden" id="cvInfoDirectoryPath">
        <input type="hidden" id="cvInfoPanel">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveCVInfo()">
          <i class="bi bi-save"></i> Save
        </button>
      </div>
    </div>
  </div>
</div>
<!-- End of ComicVine URL Modal -->

<!-- Update XML Modal -->
<div class="modal fade" id="updateXmlModal" tabindex="-1" aria-labelledby="updateXmlModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateXmlModalLabel">Update ComicInfo.xml</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="updateXmlField" class="form-label">Field to Update</label>
          <select class="form-select" id="updateXmlField">
            <option value="Volume">Volume (Year)</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="updateXmlValue" class="form-label">Value</label>
          <input type="text" class="form-control" id="updateXmlValue" placeholder="Enter value" maxlength="4">
          <div class="form-text" id="updateXmlHint">Enter a 4-digit year (e.g., 2024)</div>
        </div>
        <div class="text-muted small" id="updateXmlFolderInfo">
          Folder: <span id="updateXmlFolderName"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="updateXmlConfirmBtn">Update</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Update XML Modal -->

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/files.js') }}?v={{ range(1000, 9999) | random }}&t=202502"></script>
<script
  src="{{ url_for('static', filename='js/files_context_menu.js') }}?v={{ range(1000, 9999) | random }}&t=202502"></script>
<script>
// Library dropdown functions for multi-library support
async function loadLibraryDropdowns() {
    try {
        const response = await fetch('/api/libraries');
        const data = await response.json();

        if (data.success && data.libraries && data.libraries.length > 0) {
            populateLibraryMenu('sourceLibraryMenu', 'source', data.libraries);
            populateLibraryMenu('destLibraryMenu', 'destination', data.libraries);

            // Set default library name and load it
            const defaultLib = data.libraries[0];
            document.getElementById('sourceLibraryName').textContent = defaultLib.name;
            document.getElementById('destLibraryName').textContent = defaultLib.name;

            // Load default library in source panel on page load (with library ID for provider loading)
            await selectLibrary(defaultLib.path, 'source', defaultLib.name, defaultLib.id);
            await selectLibrary(defaultLib.path, 'destination', defaultLib.name, defaultLib.id);
        }
    } catch (e) {
        console.error('Error loading library dropdowns:', e);
        // Fallback to /data
        loadDirectories('/data', 'source');
        loadDirectories('/data', 'destination');
    }
}

function populateLibraryMenu(menuId, panel, libraries) {
    const menu = document.getElementById(menuId);
    if (!menu) return;

    menu.innerHTML = '';

    libraries.forEach(lib => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'dropdown-item';
        a.href = '#';
        a.textContent = lib.name;
        a.onclick = function(e) {
            e.preventDefault();
            selectLibrary(lib.path, panel, lib.name, lib.id);
        };
        li.appendChild(a);
        menu.appendChild(li);
    });
}

async function selectLibrary(path, panel, name, libraryId) {
    // Update dropdown button text
    const nameSpan = document.getElementById(panel === 'source' ? 'sourceLibraryName' : 'destLibraryName');
    if (nameSpan) nameSpan.textContent = name;

    // Fetch and store providers for this library
    if (libraryId) {
        const providers = await fetchLibraryProviders(libraryId);
        if (panel === 'source') {
            sourceLibraryId = libraryId;
            sourceLibraryProviders = providers;
        } else {
            destLibraryId = libraryId;
            destLibraryProviders = providers;
        }
        console.log(`Library ${name} (${panel}): ${providers.length} providers loaded`);
    }

    // Load the library root directory
    loadDirectories(path, panel);
}

// Initialize library dropdowns on page load
document.addEventListener('DOMContentLoaded', loadLibraryDropdowns);
</script>
{% endblock %}