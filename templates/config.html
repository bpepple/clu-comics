{% extends 'base.html' %}

{% block title %}CLU: Settings Page{% endblock %}

{% block content %}

<style>
    /* Spinning icon for cache operations */
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="container-lg">
    <h2 class="text-primary-emphasis">App Settings</h2>
    <div class="mt-4">

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="libraries-tab" data-bs-toggle="tab" data-bs-target="#libraries"
                    type="button" role="tab" aria-controls="libraries" aria-selected="true">Libraries</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="file-processing-tab" data-bs-toggle="tab" data-bs-target="#file-processing"
                    type="button" role="tab" aria-controls="file-processing" aria-selected="false">File
                    Processing</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="download-api-tab" data-bs-toggle="tab" data-bs-target="#download-api"
                    type="button" role="tab" aria-controls="download-api" aria-selected="false">Download and
                    API</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="metadata-providers-tab" data-bs-toggle="tab"
                    data-bs-target="#metadata-providers" type="button" role="tab" aria-controls="metadata-providers"
                    aria-selected="false">Metadata
                    Providers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-perf-tab" data-bs-toggle="tab" data-bs-target="#system-perf"
                    type="button" role="tab" aria-controls="system-perf" aria-selected="false">System and
                    Performance</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="personalization-tab" data-bs-toggle="tab" data-bs-target="#personalization"
                    type="button" role="tab" aria-controls="personalization"
                    aria-selected="false">Personalization</button>
            </li>
        </ul>

        <div class="tab-content" id="configTabsContent">

            <!-- ========================================== -->
            <!-- TAB 0: Libraries -->
            <!-- ========================================== -->
            <div class="tab-pane fade show active" id="libraries" role="tabpanel" aria-labelledby="libraries-tab">
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Comic Libraries</h4>
                    <p class="text-muted">Configure your comic library locations. Each library can have a custom name
                        and path.</p>

                    <div id="librariesList" class="mb-3">
                        <!-- Libraries will be loaded here by JavaScript -->
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading libraries...</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="showAddLibraryModal()">
                        <i class="bi bi-plus-lg me-1"></i> Add Library
                    </button>

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Note:</strong> For libraries, you must first add the volume mapping in your Docker
                        configuration
                        (e.g., <code>/e/Manga:/manga</code>), then add the library path here (e.g.,
                        <code>/manga</code>).
                    </div>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- TAB 1: File Processing -->
            <!-- ========================================== -->
            <div class="tab-pane fade" id="file-processing" role="tabpanel" aria-labelledby="file-processing-tab">

                <!-- Folder Monitoring Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Folder Monitoring</h4>
                    <p class="text-muted">Configure the <code>Watched</code> and <code>Target</code> folders. Other
                        monitoring features can be adjusted here as well.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="watch" class="form-label">WATCH:</label>
                            <input type="text" name="watch" id="watch" value="{{ watch }}" class="form-control">
                            <small class="form-text text-muted">
                                Enter the path to the directory to monitor for downloaded files.
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label for="target" class="form-label">TARGET:</label>
                            <input type="text" name="target" id="target" value="{{ target }}" class="form-control">
                            <small class="form-text text-muted">
                                Enter the path where renamed files will be moved.
                            </small>
                        </div>
                    </div>

                    <hr>

                    <!-- Checkboxes for AutoConvert & Subdirectories -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="autoConvert"
                                    name="autoConvert" {% if autoConvert %}checked{% endif %}>
                                <label class="form-check-label" for="autoConvert">Auto Convert to CBZ</label>
                                <small class="form-text text-muted">
                                    <br />Enables auto-conversion of CBR/RAR files to CBZ in your Watch folder.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="readSubdirectories"
                                    name="readSubdirectories" {% if readSubdirectories %}checked{% endif %}>
                                <label class="form-check-label" for="readSubdirectories">Process Sub-Directories</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, the app will process files in sub-directories of your
                                    <code>{{ watch }}</code> folder.
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="autoUnpack"
                                    name="autoUnpack" {% if autoUnpack %}checked{% endif %}>
                                <label class="form-check-label" for="autoUnpack">Auto-Unpack ZIP Files</label>
                                <small class="form-text text-muted">
                                    <br />When enabled, ZIP files placed in the Watch folder will automatically be
                                    unzipped.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="moveDirectory"
                                    name="moveDirectory" {% if moveDirectory %}checked{% endif %}>
                                <label class="form-check-label" for="moveDirectory">Auto-Move Sub-Directories</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, when processing files in your <code>{{ watch }}</code> folder, the
                                    sub-dirctories will be moved as well.
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="consolidateDirectories" name="consolidateDirectories" {% if
                                    consolidateDirectories %}checked{% endif %}>
                                <label class="form-check-label" for="consolidateDirectories">
                                    Consolidate Single-File Directories
                                </label>
                                <small class="form-text text-muted">
                                    <br />When a downloaded directory contains only one file,
                                    consolidate it into a series folder by stripping the issue
                                    number from the directory name.
                                    (e.g., <code>PEP Comics 140/</code> → <code>PEP Comics/</code>)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <label for="ignored_extensions" class="form-label">IGNORED EXTENSIONS:</label>
                            <input type="text" name="ignored_extensions" id="ignored_extensions"
                                value="{{ ignored_extensions }}" class="form-control">
                            <small class="form-text text-muted">
                                Enter extensions to ignore when monitoring files (e.g., .tmp, .crdownload).
                            </small>
                        </div>
                    </div>

                    <hr>

                    <!-- Cleanup Configuration -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="autoCleanupOrphanFiles" name="autoCleanupOrphanFiles" {% if
                                    autoCleanupOrphanFiles %}checked{% endif %}>
                                <label class="form-check-label" for="autoCleanupOrphanFiles">Auto-Cleanup Orphan
                                    Files</label>
                                <small class="form-text text-muted">
                                    <br />Automatically removes temporary download files (.crdownload, .tmp, .part) from
                                    the downloads folder.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="cleanupIntervalHours" class="form-label">CLEANUP INTERVAL (HOURS):</label>
                            <input type="number" name="cleanupIntervalHours" id="cleanupIntervalHours"
                                value="{{ cleanupIntervalHours }}" class="form-control" min="1" max="24">
                            <small class="form-text text-muted">
                                How often to automatically clean up orphan files (1-24 hours).
                            </small>
                        </div>
                    </div>

                </div>

                <!-- Directory Processing Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Directory & File Processing Settings</h4>
                    <p class="text-muted">Settings related to Directory processing features.</p>

                    <!-- Checkboxes for Traverse Subdirectories -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="convertSubdirectories"
                                    name="convertSubdirectories" {% if convertSubdirectories %}checked{% endif %}>
                                <label class="form-check-label" for="convertSubdirectories">Auto-Convert
                                    Sub-Directories</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, when performing CBR --> CBZ conversion on a directory, CLU will
                                    convert all files in subdirectories as well.
                                </small>
                            </div>
                        </div>
                    </div>
                    <p class="text-muted">Settings related to Directory & File processing features.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="skippedFiles" class="form-label">SKIPPED FILE TYPES:</label>
                            <input type="text" name="skippedFiles" id="skippedFiles" value="{{ skippedFiles }}"
                                class="form-control">
                            <small class="form-text text-muted">
                                When any operation unpacks a RAR/ZIP File, files with these extensions will be skipped.
                                They will be re-added to the archive.
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label for="deletedFiles" class="form-label">DELETED FILE TYPES:</label>
                            <input type="text" name="deletedFiles" id="deletedFiles" value="{{ deletedFiles }}"
                                class="form-control">
                            <small class="form-text text-muted">
                                When any operation unpacks a RAR/ZIP File, files with these extensions will deleted
                                before the file is re-packed.
                            </small>
                        </div>
                    </div>

                </div>

                <!-- Custom Rename Pattern Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Custom Naming Settings</h4>
                    <p class="text-muted">Configure custom patterns for renaming comic files. You can use variables to
                        create your own naming convention, or leave empty to use the default rename logic.</p>

                    <div class="row">
                        <!-- Enable Custom Rename -->
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="enableCustomRename"
                                    name="enableCustomRename" {% if enableCustomRename %}checked{% endif %}>
                                <label class="form-check-label" for="enableCustomRename">Use Custom Rename
                                    Patterns</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, files will be renamed using your custom pattern instead of the
                                    default rename logic.
                                </small>
                            </div>
                        </div>
                        <!-- Enable Auto Rename Enable -->
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="enableAutoRename"
                                    name="enableAutoRename" {% if enableAutoRename %}checked{% endif %}>
                                <label class="form-check-label" for="enableAutoRename">Auto-Rename Files</label>
                                <small class="form-text text-muted">
                                    <br />Automatically rename files after metadata is fetched from the API.
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <label for="customRenamePattern" class="form-label">Custom Rename Pattern:</label>
                            <input type="text" name="customRenamePattern" id="customRenamePattern"
                                value="{{ customRenamePattern }}" class="form-control"
                                placeholder="e.g., {series_name} {issue_number} ({year})">
                            <small class="form-text text-muted">
                                Use variables to create your naming pattern. Available variables:
                                <code>{series_name}</code>, <code>{volume_number}</code>, <code>{year}</code>,
                                <code>{issue_number}</code>, <code>{issue_title}</code>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Example Preview:</label>
                            <div class="border rounded p-2 bg-light">
                                <small id="renamePreview">Enter a pattern to see preview...</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-12">
                            <small class="text-muted">
                                <strong>Examples:</strong><br>
                                • <code>{series_name} {issue_number} ({year})</code> →
                                <code>Spider-Man 2099 044 (1992).cbz</code><br>
                                • <code>{series_name} [{year}] {issue_number}</code> →
                                <code>Spider-Man 2099 [1992] 044.cbz</code><br>
                                • <code>issue{issue_number}</code> → <code>issue001.cbz</code><br>
                                • <code>{volume_number}_{issue_number}</code> → <code>v2_044.cbz</code><br>
                                • <code>{series_name} {issue_number} - {issue_title} ({year})</code> →
                                <code>Spider-Man 2099 044 - The Last Dance (1992).cbz</code>
                            </small>
                        </div>
                    </div>

                    <!-- Custom Move Pattern -->
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <label for="customMovePattern" class="form-label">Custom Folder Pattern:</label>
                            <input type="text" name="customMovePattern" id="customMovePattern"
                                value="{{ customMovePattern }}" class="form-control"
                                placeholder="e.g., {publisher}/{series_name}/v{start_year}">
                            <small class="form-text text-muted">
                                Define the folder structure to use when adding series to your Pull List. Available
                                variables:
                                <code>{publisher}</code>, <code>{series_name}</code>, <code>{volume_number}</code>,
                                <code>{start_year}</code>, <code>{issue_number}</code>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Example Preview:</label>
                            <div class="border rounded p-2 bg-light">
                                <small id="movePreview">Enter a pattern to see preview...</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-12">
                            <small class="text-muted">
                                <strong>Examples:</strong><br>
                                • <code>{publisher}/{series_name}/v{start_year}</code> →
                                <code>Marvel/Spider-Man 2099/v1992/</code><br>
                                • <code>{publisher}/{series_name}</code> → <code>Marvel/Spider-Man 2099/</code><br>
                                • <code>{series_name} [{start_year}]</code> → <code>Spider-Man 2099 [1992]/</code><br>
                                • <code>{publisher}/{volume_number}</code> → <code>Marvel/v2/</code>
                            </small>
                        </div>
                    </div>

                </div>

                <!-- Save Button for Tab 1 -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveFileProcessingSettings()">
                        <i class="bi bi-floppy"></i> Save File Processing Settings
                    </button>
                </div>

            </div>

            <!-- ========================================== -->
            <!-- TAB 2: Download and API -->
            <!-- ========================================== -->
            <div class="tab-pane fade" id="download-api" role="tabpanel" aria-labelledby="download-api-tab">

                <!-- Download API Settings -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>API Download Configuration</h4>
                    <p class="text-muted">These options, along with the Chrome extension, will let you `right-click`
                        links and send them to CLU to be downloaded to your <code>/watch</code> folder.</p>

                    <div class="row">
                        <div class="col-md-12">
                            <label for="customHeaders" class="form-label">Custom Headers (JSON)</label>
                            <textarea class="form-control" id="customHeaders" name="customHeaders" rows="4"
                                placeholder="JSON Custom Headers">{{ customHeaders }}</textarea>
                            <small class="form-text text-muted">
                                Similar to the Chrome Extension, enter any authentication details here that need to be
                                passed to your URL/domain/Tunnel/VPN.
                            </small>
                        </div>


                    </div>
                </div>

                <!-- Download Provider Priority -->

                <div class="container p-4 border rounded shadow-sm mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Download Provider Priority</h4>
                            <p class="text-muted">Set the order CLU tries download providers from GetComics.
                                If a provider fails or its link isn't available, CLU tries the next one.</p>

                            <ul class="list-group" id="providerPriorityList" style="max-width: 400px;">
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <label for="pixeldrainApiKey" class="form-label">PixelDrain API Key</label>
                            <div class="input-group">
                                <input type="password" name="pixeldrainApiKey" id="pixeldrainApiKey"
                                    value="{{ pixeldrainApiKey }}" class="form-control password-field"
                                    placeholder="Enter your PixelDrain API key" autocomplete="off">
                                <button class="btn btn-outline-secondary toggle-password" type="button"
                                    data-target="pixeldrainApiKey">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Optional: Enter your PixelDrain API key for authenticated downloads. This enables access
                                to private files and higher download limits.
                            </small>
                            <div class="alert alert-info">
                                <strong>PixelDrain</strong> is a recommended service. $10 of <a
                                    href="https://pixeldrain.com/home#" target="_blank">Pre-Paid service should
                                    easily last you all year</a> and you'll see download speed improvements with 5GB
                                downloads in a matter of minutes.
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Metadata API Settings -->
                <div class="container p-4 border rounded shadow-sm mb-4">


                </div>

                <!-- Komga Reading Sync -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4><i class="bi bi-book me-2"></i>Komga Reading Sync</h4>
                            <p class="text-muted mb-0">Sync reading history and progress from your Komga server to CLU.
                            </p>
                        </div>
                        <span id="komgaStatusBadge" class="badge bg-secondary">
                            <i class="bi bi-x-circle me-1"></i>Not Configured
                        </span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="komgaServerUrl" class="form-label">Server URL</label>
                            <input type="text" class="form-control" id="komgaServerUrl" placeholder="http://komga:25600"
                                autocomplete="url">
                            <small class="form-text text-muted">
                                Full URL to your Komga server (e.g., http://192.168.1.100:25600)
                            </small>
                        </div>
                        <div class="col-md-3">
                            <label for="komgaUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="komgaUsername" placeholder="user@email.com"
                                autocomplete="username">
                        </div>
                        <div class="col-md-3">
                            <label for="komgaPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-field" id="komgaPassword"
                                    placeholder="Password" autocomplete="current-password">
                                <button class="btn btn-outline-secondary toggle-password" type="button"
                                    data-target="komgaPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">
                    <h6>Library Path Mapping</h6>
                    <p class="text-muted small">Map each CLU library to its corresponding Komga path prefix.
                        Leave the Komga path empty to skip a library during sync.</p>
                    <div id="komgaLibraryMappings">
                        <p class="text-muted small fst-italic">Loading libraries...</p>
                    </div>

                    <hr class="my-3">
                    <h6>Sync Schedule</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="komgaSyncFrequency" class="form-label">Frequency</label>
                            <select class="form-select" id="komgaSyncFrequency">
                                <option value="disabled">Disabled</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="komgaSyncTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="komgaSyncTime" value="05:00">
                        </div>
                        <div class="col-md-3" id="komgaWeekdayGroup" style="display:none;">
                            <label for="komgaSyncWeekday" class="form-label">Day</label>
                            <select class="form-select" id="komgaSyncWeekday">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sync Status -->
                    <div class="alert alert-info mt-3" id="komgaSyncStatus" style="display:none;">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Last Sync:</strong><br>
                                <span id="komgaLastSync">Never</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Total Read Synced:</strong><br>
                                <span id="komgaReadCount">0</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Total Progress Synced:</strong><br>
                                <span id="komgaProgressCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-3 d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-sm" onclick="saveKomgaConfig()">
                            <i class="bi bi-floppy me-1"></i>Save
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="komgaTestBtn"
                            onclick="testKomgaConnection()">
                            <i class="bi bi-lightning me-1"></i>Test Connection
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" id="komgaSyncBtn"
                            onclick="syncKomgaNow()">
                            <i class="bi bi-arrow-repeat me-1"></i>Sync Now
                        </button>
                    </div>
                </div>

                <!-- Save Button for Tab 2 -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveDownloadApiSettings()">
                        <i class="bi bi-floppy"></i> Save Download & API Settings
                    </button>
                </div>

            </div>

            <!-- ========================================== -->
            <!-- TAB 3: Metadata Providers -->
            <!-- ========================================== -->
            <div class="tab-pane fade" id="metadata-providers" role="tabpanel" aria-labelledby="metadata-providers-tab">

                <!-- Provider Credentials -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Provider Credentials</h4>
                    <p class="text-muted">Configure API credentials for metadata providers. Credentials are stored
                        encrypted.</p>

                    <div id="providersCredentialsList" class="mb-3">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading providers...</span>
                        </div>
                    </div>
                </div>

                <!-- Library Provider Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Library Provider Settings</h4>
                    <p class="text-muted">Configure which metadata providers to use for each library and their priority
                        order.</p>

                    <div id="libraryProvidersList" class="mb-3">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading library settings...</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ========================================== -->
            <!-- TAB 4: System and Performance -->
            <!-- ========================================== -->
            <div class="tab-pane fade" id="system-perf" role="tabpanel" aria-labelledby="system-perf-tab">

                <!-- Performance & Timeout Settings -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Performance & Timeout Settings</h4>
                    <p class="text-muted">Configure timeout settings for large file operations and performance
                        optimizations.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="operationTimeout" class="form-label">Operation Timeout (seconds):</label>
                            <input type="number" name="operationTimeout" id="operationTimeout"
                                value="{{ operationTimeout }}" class="form-control" min="300" max="7200">
                            <small class="form-text text-muted">
                                Timeout for large file operations (convert, rebuild). Default: 3600 seconds (1 hour).
                                Minimum: 300 seconds (5 minutes).
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label for="largeFileThreshold" class="form-label">Large File Threshold (MB):</label>
                            <input type="number" name="largeFileThreshold" id="largeFileThreshold"
                                value="{{ largeFileThreshold }}" class="form-control" min="100" max="2000">
                            <small class="form-text text-muted">
                                Files larger than this size (in MB) will get enhanced progress reporting. Default: 500
                                MB.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Timezone Settings -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Timezone Settings</h4>
                    <p class="text-muted">Set your local timezone for accurate reading history tracking.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="timezone" class="form-label">Timezone:</label>
                            <select name="timezone" id="timezone" class="form-select">
                                <option value="UTC" {% if timezone=='UTC' %}selected{% endif %}>UTC</option>
                                <option value="-12" {% if timezone=='-12' %}selected{% endif %}>UTC-12 (Baker Island)
                                </option>
                                <option value="-11" {% if timezone=='-11' %}selected{% endif %}>UTC-11 (Samoa)</option>
                                <option value="-10" {% if timezone=='-10' %}selected{% endif %}>UTC-10 (Hawaii)</option>
                                <option value="-9" {% if timezone=='-9' %}selected{% endif %}>UTC-9 (Alaska)</option>
                                <option value="-8" {% if timezone=='-8' %}selected{% endif %}>UTC-8 (Pacific)</option>
                                <option value="-7" {% if timezone=='-7' %}selected{% endif %}>UTC-7 (Mountain)</option>
                                <option value="-6" {% if timezone=='-6' %}selected{% endif %}>UTC-6 (Central)</option>
                                <option value="-5" {% if timezone=='-5' %}selected{% endif %}>UTC-5 (Eastern)</option>
                                <option value="-4" {% if timezone=='-4' %}selected{% endif %}>UTC-4 (Atlantic)</option>
                                <option value="-3" {% if timezone=='-3' %}selected{% endif %}>UTC-3 (Brazil)</option>
                                <option value="0" {% if timezone=='0' %}selected{% endif %}>UTC+0 (London)</option>
                                <option value="1" {% if timezone=='1' %}selected{% endif %}>UTC+1 (Paris)</option>
                                <option value="2" {% if timezone=='2' %}selected{% endif %}>UTC+2 (Cairo)</option>
                                <option value="5.5" {% if timezone=='5.5' %}selected{% endif %}>UTC+5:30 (India)
                                </option>
                                <option value="8" {% if timezone=='8' %}selected{% endif %}>UTC+8 (Singapore)</option>
                                <option value="9" {% if timezone=='9' %}selected{% endif %}>UTC+9 (Tokyo)</option>
                                <option value="10" {% if timezone=='10' %}selected{% endif %}>UTC+10 (Sydney)</option>
                                <option value="12" {% if timezone=='12' %}selected{% endif %}>UTC+12 (Auckland)</option>
                            </select>
                            <small class="form-text text-muted">
                                Affects how reading history dates are displayed on the Insights page.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Cache Management -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Cache Management</h4>
                    <p class="text-muted">Clear cached data to refresh statistics and file listings.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" id="clearCacheBtn" class="btn btn-warning">
                                <i class="bi bi-trash"></i> Clear All Caches
                            </button>
                            <small class="form-text text-muted d-block mt-2">
                                Clears directory cache and statistics cache (Insights charts). Use this if data appears
                                stale.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- File Index Management Settings -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Index & Sync Management</h4>
                    <p class="text-muted">
                        Manage the application's file search index stored in SQLite. The index provides fast searching
                        across your entire library.
                        <br><br>
                        <strong>How it works:</strong> The file index is stored persistently in the database and
                        automatically updates when you move, rename, or delete files.
                        You can manually rebuild it or schedule automatic rebuilds to ensure data accuracy.
                    </p>

                    <!-- Index Status Display -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Index Status:</strong><br>
                                        <span id="indexStatus">Checking...</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Last Rebuild:</strong><br>
                                        <span id="lastRebuild">Checking...</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Next Scheduled:</strong><br>
                                        <span id="nextScheduled">Not scheduled</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12 text-center">
                                        <button type="button" class="btn btn-sm btn-outline-info"
                                            onclick="updateIndexStatus()" title="Refresh index status">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Rebuild Button -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary w-100" onclick="rebuildFileIndex()"
                                title="Manually rebuild the file index">
                                <i class="bi bi-arrow-clockwise"></i> Rebuild File Index Now
                            </button>
                            <small class="form-text text-muted">
                                Manually rebuild the entire file index. This scans all files in your data directory and
                                updates the database. Use this if search results seem outdated.
                            </small>
                        </div>
                    </div>

                    <!-- Scheduled Rebuild Configuration -->
                    <hr>
                    <h5 class="mt-3 mb-3">Automatic Rebuild Schedule</h5>
                    <p class="text-muted">Configure automatic file index rebuilds to keep your search results
                        up-to-date.</p>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="rebuildFrequency" class="form-label">Rebuild Frequency:</label>
                            <select class="form-select" id="rebuildFrequency" name="rebuildFrequency">
                                <option value="disabled">Disabled</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                            <small class="form-text text-muted">
                                How often the file index should automatically rebuild.
                            </small>
                        </div>

                        <div class="col-md-4">
                            <label for="rebuildTime" class="form-label">Rebuild Time:</label>
                            <input type="time" class="form-control" id="rebuildTime" name="rebuildTime" value="02:00">
                            <small class="form-text text-muted">
                                Time of day to run the rebuild (24-hour format).
                            </small>
                        </div>

                        <div class="col-md-4" id="weekdaySelectContainer" style="display: none;">
                            <label for="rebuildWeekday" class="form-label">Day of Week:</label>
                            <select class="form-select" id="rebuildWeekday" name="rebuildWeekday">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                            <small class="form-text text-muted">
                                Which day of the week to run the rebuild.
                            </small>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-success w-100" onclick="saveRebuildSchedule()"
                                title="Save the rebuild schedule">
                                <i class="bi bi-floppy"></i> Save Schedule
                            </button>
                        </div>
                    </div>

                    <!-- Scheduled Series Sync Configuration -->
                    <hr>
                    <h5 class="mt-3 mb-3">Automatic Series Sync Schedule</h5>
                    <p class="text-muted">Configure automatic syncing of tracked series from Metron API to check for new
                        issues.</p>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="syncFrequency" class="form-label">Sync Frequency:</label>
                            <select class="form-select" id="syncFrequency" name="syncFrequency">
                                <option value="disabled">Disabled</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                            <small class="form-text text-muted">
                                How often to sync series data from Metron API.
                            </small>
                        </div>

                        <div class="col-md-4">
                            <label for="syncTime" class="form-label">Sync Time:</label>
                            <input type="time" class="form-control" id="syncTime" name="syncTime" value="03:00">
                            <small class="form-text text-muted">
                                Time of day to run the sync (24-hour format).
                            </small>
                        </div>

                        <div class="col-md-4" id="syncWeekdaySelectContainer" style="display: none;">
                            <label for="syncWeekday" class="form-label">Day of Week:</label>
                            <select class="form-select" id="syncWeekday" name="syncWeekday">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                            <small class="form-text text-muted">
                                Which day of the week to run the sync.
                            </small>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-success w-100" onclick="saveSyncSchedule()"
                                title="Save the sync schedule">
                                <i class="bi bi-floppy"></i> Save Sync Schedule
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="runSyncNow()"
                                title="Run sync immediately">
                                <i class="bi bi-arrow-repeat"></i> Sync Now
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <small class="text-muted" id="lastSyncDisplay"></small>
                        </div>
                    </div>

                    <!-- GetComics Auto-Download Configuration -->
                    <hr>
                    <h5 class="mt-3 mb-3">GetComics Auto-Download Schedule</h5>
                    <p class="text-muted">Automatically search GetComics for wanted issues (with today's release date or
                        later) and queue downloads.</p>

                    <!-- Weekly Packs Warning Banner -->
                    <div id="weeklyPacksWarning" class="alert alert-info d-none mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Weekly Packs Enabled:</strong> Individual issue auto-download is disabled because Weekly
                        Packs is enabled.
                        <a href="{{ url_for('downloads.weekly_packs') }}">Manage Weekly Packs</a>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="getcomicsFrequency" class="form-label">Download Frequency:</label>
                            <select class="form-select" id="getcomicsFrequency" name="getcomicsFrequency">
                                <option value="disabled">Disabled</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                            <small class="form-text text-muted">
                                How often to search GetComics for wanted issues.
                            </small>
                        </div>

                        <div class="col-md-4">
                            <label for="getcomicsTime" class="form-label">Download Time:</label>
                            <input type="time" class="form-control" id="getcomicsTime" name="getcomicsTime"
                                value="03:00">
                            <small class="form-text text-muted">
                                Time of day to search and download (24-hour format).
                            </small>
                        </div>

                        <div class="col-md-4" id="getcomicsWeekdaySelectContainer" style="display: none;">
                            <label for="getcomicsWeekday" class="form-label">Day of Week:</label>
                            <select class="form-select" id="getcomicsWeekday" name="getcomicsWeekday">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                            <small class="form-text text-muted">
                                Which day of the week to run the download.
                            </small>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-success w-100" onclick="saveGetcomicsSchedule()"
                                title="Save the GetComics schedule">
                                <i class="bi bi-floppy"></i> Save GetComics Schedule
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="runGetcomicsNow()"
                                title="Run GetComics download immediately">
                                <i class="bi bi-cloud-download"></i> Download Now
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <small class="text-muted" id="lastGetcomicsDisplay"></small>
                        </div>
                    </div>
                </div>

                <!-- Missing Issue Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Missing Issue Configuration</h4>
                    <p class="text-muted">Update these settings to ignore terms or files when the app is performing a
                        <strong>Missing Issue</strong> scan.
                    </p>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="ignored_terms" class="form-label">IGNORED TERMS:</label>
                            <input type="text" name="ignored_terms" id="ignored_terms" value="{{ ignored_terms }}"
                                class="form-control">
                            <small class="form-text text-muted">
                                Enter words or terms to ignore while performing a Missing Issue search. Terms must be
                                comma-separated.
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label for="ignored_files" class="form-label">IGNORED FILES:</label>
                            <input type="text" name="ignored_files" id="ignored_files" value="{{ ignored_files }}"
                                class="form-control">
                            <small class="form-text text-muted">
                                Enter comma-separated file names to ignore when checking for missing issues (e.g.,
                                cover.jpg, cvinfo).
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Logging & Debugging Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Logging & Debugging</h4>
                    <p class="text-muted">Configure application logging settings. Debug logging provides detailed
                        diagnostic information useful for troubleshooting.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="enableDebugLogging"
                                    name="enableDebugLogging" {% if enableDebugLogging %}checked{% endif %}>
                                <label class="form-check-label" for="enableDebugLogging">{% if enableDebugLogging
                                    %}Disable{% else %}Enable{% endif %} Debug Logging</label>
                                <small class="form-text text-muted">
                                    <br />When enabled, detailed debug messages will appear in the <a href="/app-logs"
                                        target="_blank">App Logs</a>. This can help with troubleshooting but may
                                    increase log file size. Changes take effect after saving.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ComicInfo XML editing Configuration -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>ComicInfo.XML Update Settings</h4>
                    <p class="text-muted">Enable/Disable features for updating or cleaning <code>ComicInfo.xml</code>
                        files. This proecess runs on a single directory, extracts the <code>ComicInfo.xml</code> file,
                        reads and makes updates and then recompresses the file.</p>

                    <!-- Checkboxes for ComicInfo.xml options -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="xmlYear"
                                    name="xmlYear" {% if xmlYear %}checked{% endif %}>
                                <label class="form-check-label" for="xmlYear">{% if xmlYear %}Disable{% else %}Enable{%
                                    endif %} Update Volume to First Issue Year</label>
                                <small class="form-text text-muted">
                                    <br />Reads the alpha-numeric first file in the directory and attempts to extract
                                    the 4-digit year from the filename.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input xml-checkbox" type="checkbox" role="switch"
                                    id="xmlMarkdown" name="xmlMarkdown" {% if xmlMarkdown %}checked{% endif %}>
                                <label class="form-check-label" for="xmlMarkdown">{% if xmlMarkdown %}Disable{% else
                                    %}Enable{% endif %} Removing ALL Markdown Content from Comments</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, when the ComicInfo.xml update function is run, the
                                    <code>Comments</code> will have all headers, bold text and tables removed.
                                </small>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input xml-checkbox" type="checkbox" role="switch" id="xmlList"
                                    name="xmlList" {% if xmlList %}checked{% endif %}>
                                <label class="form-check-label" for="xmlList">{% if xmlList %}Disable{% else %}Enable{%
                                    endif %} Removing 'Covers & Creators' table from Comments</label>
                                <small class="form-text text-muted">
                                    <br />If enabled, when the ComicInfo.xml update function is run, 'Covers & Creators'
                                    tables will be removed from the <code>Comments</code>.
                                </small>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Save Button for Tab 4 - System & Performance -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveSystemPerfSettings()">
                        <i class="bi bi-floppy"></i> Save System & Performance Settings
                    </button>
                </div>

            </div>

            <!-- ========================================== -->
            <!-- TAB 4: Styling -->
            <!-- ========================================== -->
            <!-- ========================================== -->
            <!-- TAB: Personalization -->
            <!-- ========================================== -->
            <div class="tab-pane fade" id="personalization" role="tabpanel" aria-labelledby="personalization-tab">

                <!-- Theme Selection -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4>Theme Selection</h4>
                    <p class="text-muted">Choose a Bootstrap theme for the application. Themes provided by <a
                            href="https://bootswatch.com/" target="_blank">Bootswatch</a>.</p>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="bootstrapTheme" class="form-label">Bootstrap Theme:</label>
                            <select class="form-select" id="bootstrapTheme" name="bootstrapTheme">
                                <option value="default" {% if bootstrapTheme=='default' %}selected{% endif %}>Default
                                    (Bootstrap)</option>
                                <option value="brite" {% if bootstrapTheme=='brite' %}selected{% endif %}>Brite
                                </option>
                                <option value="cerulean" {% if bootstrapTheme=='cerulean' %}selected{% endif %}>Cerulean
                                </option>
                                <option value="cosmo" {% if bootstrapTheme=='cosmo' %}selected{% endif %}>Cosmo</option>
                                <option value="cyborg" {% if bootstrapTheme=='cyborg' %}selected{% endif %}>Cyborg
                                    (Dark)</option>
                                <option value="darkly" {% if bootstrapTheme=='darkly' %}selected{% endif %}>Darkly
                                    (Dark)</option>
                                <option value="flatly" {% if bootstrapTheme=='flatly' %}selected{% endif %}>Flatly
                                </option>
                                <option value="journal" {% if bootstrapTheme=='journal' %}selected{% endif %}>Journal
                                </option>
                                <option value="litera" {% if bootstrapTheme=='litera' %}selected{% endif %}>Litera
                                </option>
                                <option value="lumen" {% if bootstrapTheme=='lumen' %}selected{% endif %}>Lumen</option>
                                <option value="lux" {% if bootstrapTheme=='lux' %}selected{% endif %}>Lux</option>
                                <option value="materia" {% if bootstrapTheme=='materia' %}selected{% endif %}>Materia
                                </option>
                                <option value="minty" {% if bootstrapTheme=='minty' %}selected{% endif %}>Minty</option>
                                <option value="morph" {% if bootstrapTheme=='morph' %}selected{% endif %}>Morph</option>
                                <option value="pulse" {% if bootstrapTheme=='pulse' %}selected{% endif %}>Pulse</option>
                                <option value="quartz" {% if bootstrapTheme=='quartz' %}selected{% endif %}>Quartz
                                    (Dark)</option>
                                <option value="sandstone" {% if bootstrapTheme=='sandstone' %}selected{% endif %}>
                                    Sandstone</option>
                                <option value="simplex" {% if bootstrapTheme=='simplex' %}selected{% endif %}>Simplex
                                </option>
                                <option value="sketchy" {% if bootstrapTheme=='sketchy' %}selected{% endif %}>Sketchy
                                </option>
                                <option value="slate" {% if bootstrapTheme=='slate' %}selected{% endif %}>Slate (Dark)
                                </option>
                                <option value="solar" {% if bootstrapTheme=='solar' %}selected{% endif %}>Solar (Dark)
                                </option>
                                <option value="spacelab" {% if bootstrapTheme=='spacelab' %}selected{% endif %}>Spacelab
                                </option>
                                <option value="superhero" {% if bootstrapTheme=='superhero' %}selected{% endif %}>
                                    Superhero (Dark)</option>
                                <option value="united" {% if bootstrapTheme=='united' %}selected{% endif %}>United
                                </option>
                                <option value="vapor" {% if bootstrapTheme=='vapor' %}selected{% endif %}>Vapor (Dark)
                                </option>
                                <option value="yeti" {% if bootstrapTheme=='yeti' %}selected{% endif %}>Yeti</option>
                                <option value="zephyr" {% if bootstrapTheme=='zephyr' %}selected{% endif %}>Zephyr
                                </option>
                            </select>
                            <small class="form-text text-muted">
                                Select a theme to change the look and feel of the application. Dark themes are marked.
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Theme Preview:</label>
                            <div class="border rounded p-2 text-center">
                                <img id="themePreviewImg"
                                    src="https://bootswatch.com/{{ bootstrapTheme|default('default') }}/thumbnail.png"
                                    alt="Theme preview" class="img-fluid rounded" style="max-height: 200px;"
                                    onerror="this.src='/static/images/default.png'">
                                <div class="mt-2">
                                    <strong id="themePreviewName">{{ bootstrapTheme|default('default')|title }}</strong>
                                    <br><small class="text-muted">Save settings to apply this theme.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button - Styling -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveStylingSettings()">
                        <i class="bi bi-floppy"></i> Save Styling Settings
                    </button>
                </div>

                <hr>

                <!-- Dashboard Layout -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4><i class="bi bi-layout-text-window-reverse me-2"></i>Dashboard Layout</h4>
                    <p class="text-muted">Configure which sections appear on your collection dashboard and their display
                        order.</p>

                    {% set sections_meta = {
                    'favorites': {'name': 'Favorite Collections', 'icon': 'bi-bookmark-heart-fill text-danger'},
                    'want_to_read': {'name': 'Want to Read', 'icon': 'bi-bookmark-star-fill text-warning'},
                    'continue_reading': {'name': 'Continue Reading', 'icon': 'bi-book-half text-info'},
                    'discover': {'name': 'Discover / Recommendations', 'icon': 'bi-stars text-warning'},
                    'recently_added': {'name': 'Recently Added', 'icon': 'bi-clock-history text-primary'},
                    'library': {'name': 'Library', 'icon': 'bi-collection-fill text-primary'}
                    } %}
                    <ul class="list-group" id="dashboardSectionsList" style="max-width: 600px;">
                        {% for section_id in dashboard_order %}
                        {% if section_id in sections_meta %}
                        {% set meta = sections_meta[section_id] %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-section-id="{{ section_id }}">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input dashboard-visible-check me-3" {{ '' if
                                    section_id in dashboard_hidden else 'checked' }}>
                                <i class="bi {{ meta.icon }} me-2"></i>
                                <strong>{{ meta.name }}</strong>
                                {% if section_id == 'discover' %}
                                <small class="text-muted ms-2">(Also requires Recommendations enabled)</small>
                                {% endif %}
                            </div>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>

                    <div class="alert alert-info mt-2 mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Changes take effect on the collection/home page after saving.
                    </div>
                </div>

                <!-- Save Button - Dashboard -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" id="saveDashboardBtn"
                        onclick="saveDashboardSettings()">
                        <i class="bi bi-floppy"></i> Save Dashboard Settings
                    </button>
                </div>

                <hr>

                <!-- Recommendation Service -->
                <div class="container p-4 border rounded shadow-sm mb-4">
                    <h4><i class="bi bi-stars text-warning"></i> Recommendation Service</h4>
                    <p class="text-muted">Configure AI-powered recommendations for your reading list. Requires an API
                        key from your preferred provider.</p>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="recEnabled" name="recEnabled" {% if
                            rec_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="recEnabled">Enable Recommendations</label>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="recProvider" class="form-label">AI Provider:</label>
                            <select class="form-select" id="recProvider" name="recProvider"
                                onchange="updateModelOptions()">
                                <option value="gemini" {% if rec_provider=='gemini' %}selected{% endif %}>Google Gemini
                                </option>
                                <option value="openai" {% if rec_provider=='openai' %}selected{% endif %}>OpenAI
                                    (ChatGPT)</option>
                                <option value="anthropic" {% if rec_provider=='anthropic' %}selected{% endif %}>
                                    Anthropic (Claude)</option>
                            </select>
                            <small class="form-text text-muted">
                                Select the AI service provider.
                            </small>
                        </div>

                        <div class="col-md-8">
                            <label for="recApiKey" class="form-label">API Key:</label>
                            <div class="input-group">
                                <input type="password" name="recApiKey" id="recApiKey" value="{{ rec_api_key }}"
                                    class="form-control password-field" autocomplete="off">
                                <button class="btn btn-outline-secondary toggle-password" type="button"
                                    data-target="recApiKey">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Your API key is stored locally in the application database.
                            </small>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="recModel" class="form-label">Model:</label>
                            <select class="form-select" id="recModel" name="recModel">
                                <!-- Populated via JS based on provider -->
                                <option value="{{ rec_model }}" selected>{{ rec_model }}</option>
                            </select>
                            <small class="form-text text-muted">
                                Select the specific model to use.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Save Button - Recommendations -->
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="saveRecommendationSettings()">
                        <i class="bi bi-floppy"></i> Save Recommendation Settings
                    </button>
                </div>

            </div>
        </div>

    </div>

    <!-- Restart Button -->
    <div class="container p-4 border rounded shadow-sm text-center">
        <h6>Restart Flask App</h6>
        <button onclick="restartApp()" class="btn btn-secondary">Restart App</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Toast notification system for config.html
    function showToast(message, type = 'info', duration = 5000) {
        // Create toast container if it doesn't exist
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        const toastId = 'toast-' + Date.now();
        const iconMap = {
            'success': 'bi-check-circle-fill text-success',
            'error': 'bi-exclamation-triangle-fill text-danger',
            'warning': 'bi-exclamation-triangle-fill text-warning',
            'info': 'bi-info-circle-fill text-info'
        };

        const toastHtml = `
            <div id="${toastId}" class="toast bg-white border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bi ${iconMap[type]} me-2"></i>
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            delay: duration,
            autohide: duration > 0
        });

        toast.show();

        // Remove from DOM after hiding
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });

        return toast;
    }

    function restartApp() {
        fetch('/restart', { method: 'POST' })
            .then(response => response.json())
            .then(data => showToast(data.message, 'success'))
            .catch(error => console.error('Error:', error));
    }

    // =========================================
    // Tab-specific AJAX Save Functions
    // =========================================

    async function saveFileProcessingSettings() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            watch: document.getElementById('watch')?.value || '',
            target: document.getElementById('target')?.value || '',
            autoConvert: document.getElementById('autoConvert')?.checked || false,
            readSubdirectories: document.getElementById('readSubdirectories')?.checked || false,
            autoUnpack: document.getElementById('autoUnpack')?.checked || false,
            moveDirectory: document.getElementById('moveDirectory')?.checked || false,
            consolidateDirectories: document.getElementById('consolidateDirectories')?.checked || false,
            ignored_extensions: document.getElementById('ignored_extensions')?.value || '',
            autoCleanupOrphanFiles: document.getElementById('autoCleanupOrphanFiles')?.checked || false,
            cleanupIntervalHours: document.getElementById('cleanupIntervalHours')?.value || '24',
            convertSubdirectories: document.getElementById('convertSubdirectories')?.checked || false,
            skippedFiles: document.getElementById('skippedFiles')?.value || '',
            deletedFiles: document.getElementById('deletedFiles')?.value || '',
            enableCustomRename: document.getElementById('enableCustomRename')?.checked || false,
            customRenamePattern: document.getElementById('customRenamePattern')?.value || '',
            enableAutoRename: document.getElementById('enableAutoRename')?.checked || false,
            enableAutoMove: document.getElementById('enableAutoMove')?.checked || false,
            customMovePattern: document.getElementById('customMovePattern')?.value || ''
        };

        try {
            const response = await fetch('/api/config/file-processing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('File processing settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // Provider priority list with up/down arrows
    const providerLabels = { pixeldrain: 'Pixeldrain', download_now: 'GetComics', mega: 'Mega' };

    function renderProviderList() {
        const list = document.getElementById('providerPriorityList');
        const items = Array.from(list.children);
        list.innerHTML = '';
        items.forEach((item, idx) => {
            const val = item.getAttribute('data-provider');
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.setAttribute('data-provider', val);
            li.draggable = true;

            const label = document.createElement('span');
            label.innerHTML = '<span class="badge bg-secondary me-2">' + (idx + 1) + '</span>' + providerLabels[val];
            li.appendChild(label);

            const btnGroup = document.createElement('div');
            if (idx > 0) {
                const upBtn = document.createElement('button');
                upBtn.type = 'button';
                upBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                upBtn.innerHTML = '<i class="bi bi-arrow-up"></i>';
                upBtn.onclick = () => moveProvider(idx, idx - 1);
                btnGroup.appendChild(upBtn);
            }
            if (idx < items.length - 1) {
                const downBtn = document.createElement('button');
                downBtn.type = 'button';
                downBtn.className = 'btn btn-sm btn-outline-secondary';
                downBtn.innerHTML = '<i class="bi bi-arrow-down"></i>';
                downBtn.onclick = () => moveProvider(idx, idx + 1);
                btnGroup.appendChild(downBtn);
            }
            li.appendChild(btnGroup);

            // Drag events
            li.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', idx);
                li.classList.add('opacity-50');
            });
            li.addEventListener('dragend', () => li.classList.remove('opacity-50'));
            li.addEventListener('dragover', (e) => { e.preventDefault(); li.classList.add('border-primary'); });
            li.addEventListener('dragleave', () => li.classList.remove('border-primary'));
            li.addEventListener('drop', (e) => {
                e.preventDefault();
                li.classList.remove('border-primary');
                const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                moveProvider(fromIdx, idx);
            });

            list.appendChild(li);
        });
    }

    function moveProvider(fromIdx, toIdx) {
        const list = document.getElementById('providerPriorityList');
        const items = Array.from(list.children);
        const [moved] = items.splice(fromIdx, 1);
        items.splice(toIdx, 0, moved);
        list.innerHTML = '';
        items.forEach(item => list.appendChild(item));
        renderProviderList();
    }

    function getProviderPriorityValue() {
        const list = document.getElementById('providerPriorityList');
        return Array.from(list.children).map(li => li.getAttribute('data-provider')).join(',');
    }

    (function initProviderPriority() {
        const priorityStr = '{{ downloadProviderPriority }}';
        const providers = priorityStr.split(',').map(s => s.trim()).filter(Boolean);
        const list = document.getElementById('providerPriorityList');
        providers.forEach(val => {
            const li = document.createElement('li');
            li.setAttribute('data-provider', val);
            list.appendChild(li);
        });
        renderProviderList();
    })();

    async function saveDownloadApiSettings() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            customHeaders: document.getElementById('customHeaders')?.value || '',
            pixeldrainApiKey: document.getElementById('pixeldrainApiKey')?.value || '',
            comicvineApiKey: document.getElementById('comicvineApiKey')?.value || '',
            metronUsername: document.getElementById('metronUsername')?.value || '',
            metronPassword: document.getElementById('metronPassword')?.value || '',
            downloadProviderPriority: getProviderPriorityValue()
        };

        try {
            const response = await fetch('/api/config/download-api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('Download & API settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    async function saveSystemPerfSettings() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            operationTimeout: document.getElementById('operationTimeout')?.value || '3600',
            largeFileThreshold: document.getElementById('largeFileThreshold')?.value || '500',
            timezone: document.getElementById('timezone')?.value || 'UTC',
            rebuildFrequency: document.getElementById('rebuildFrequency')?.value || 'disabled',
            rebuildTime: document.getElementById('rebuildTime')?.value || '02:00',
            rebuildWeekday: document.getElementById('rebuildWeekday')?.value || '0',
            syncFrequency: document.getElementById('syncFrequency')?.value || 'disabled',
            syncTime: document.getElementById('syncTime')?.value || '03:00',
            syncWeekday: document.getElementById('syncWeekday')?.value || '0',
            getcomicsFrequency: document.getElementById('getcomicsFrequency')?.value || 'disabled',
            getcomicsTime: document.getElementById('getcomicsTime')?.value || '04:00',
            getcomicsWeekday: document.getElementById('getcomicsWeekday')?.value || '0',
            ignored_terms: document.getElementById('ignored_terms')?.value || '',
            ignored_files: document.getElementById('ignored_files')?.value || '',
            enableDebugLogging: document.getElementById('enableDebugLogging')?.checked || false,
            xmlYear: document.getElementById('xmlYear')?.checked || false,
            xmlMarkdown: document.getElementById('xmlMarkdown')?.checked || false,
            xmlList: document.getElementById('xmlList')?.checked || false
        };

        try {
            const response = await fetch('/api/config/system-perf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('System & Performance settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    async function saveStylingSettings() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            bootstrapTheme: document.getElementById('bootstrapTheme')?.value || 'darkly'
        };

        try {
            const response = await fetch('/api/config/styling', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('Styling settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    async function saveRecommendationSettings() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            recEnabled: document.getElementById('recEnabled')?.checked || false,
            recProvider: document.getElementById('recProvider')?.value || 'openai',
            recApiKey: document.getElementById('recApiKey')?.value || '',
            recModel: document.getElementById('recModel')?.value || ''
        };

        try {
            const response = await fetch('/api/config/recommendations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('Recommendation settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // Dashboard section list with up/down arrows
    function renderDashboardList() {
        const list = document.getElementById('dashboardSectionsList');
        const items = Array.from(list.children);
        list.innerHTML = '';
        items.forEach((item, idx) => {
            // Remove old arrow buttons
            const oldBtnGroup = item.querySelector('.dashboard-btn-group');
            if (oldBtnGroup) oldBtnGroup.remove();

            // Update badge number
            let badge = item.querySelector('.dashboard-order-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-2 dashboard-order-badge';
                item.querySelector('div').insertBefore(badge, item.querySelector('.form-check-input'));
            }
            badge.textContent = idx + 1;

            const btnGroup = document.createElement('div');
            btnGroup.className = 'dashboard-btn-group';
            if (idx > 0) {
                const upBtn = document.createElement('button');
                upBtn.type = 'button';
                upBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                upBtn.innerHTML = '<i class="bi bi-arrow-up"></i>';
                upBtn.onclick = () => moveDashboardSection(idx, idx - 1);
                btnGroup.appendChild(upBtn);
            }
            if (idx < items.length - 1) {
                const downBtn = document.createElement('button');
                downBtn.type = 'button';
                downBtn.className = 'btn btn-sm btn-outline-secondary';
                downBtn.innerHTML = '<i class="bi bi-arrow-down"></i>';
                downBtn.onclick = () => moveDashboardSection(idx, idx + 1);
                btnGroup.appendChild(downBtn);
            }
            item.appendChild(btnGroup);

            // Drag events
            item.draggable = true;
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', idx);
                item.classList.add('opacity-50');
            });
            item.addEventListener('dragend', () => item.classList.remove('opacity-50'));
            item.addEventListener('dragover', (e) => { e.preventDefault(); item.classList.add('border-primary'); });
            item.addEventListener('dragleave', () => item.classList.remove('border-primary'));
            item.addEventListener('drop', (e) => {
                e.preventDefault();
                item.classList.remove('border-primary');
                const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                moveDashboardSection(fromIdx, idx);
            });

            list.appendChild(item);
        });
    }

    function moveDashboardSection(fromIdx, toIdx) {
        const list = document.getElementById('dashboardSectionsList');
        const items = Array.from(list.children);
        const [moved] = items.splice(fromIdx, 1);
        items.splice(toIdx, 0, moved);
        list.innerHTML = '';
        items.forEach(item => list.appendChild(item));
        renderDashboardList();
    }

    // Initialize the dashboard list on load
    renderDashboardList();

    async function saveDashboardSettings() {
        const btn = document.getElementById('saveDashboardBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const items = Array.from(document.querySelectorAll('#dashboardSectionsList li'));
        const order = [];
        const hidden = [];
        items.forEach(item => {
            const id = item.dataset.sectionId;
            order.push(id);
            if (!item.querySelector('.dashboard-visible-check').checked) {
                hidden.push(id);
            }
        });

        const data = {
            dashboardOrder: order,
            dashboardHidden: hidden
        };

        try {
            const response = await fetch('/api/config/dashboard', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('Dashboard settings saved', 'success');
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving settings: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const xmlCheckboxes = document.querySelectorAll(".xml-checkbox");

        xmlCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                if (this.checked) {
                    xmlCheckboxes.forEach(cb => {
                        if (cb !== this) {
                            cb.checked = false;
                        }
                    });
                }
            });
        });

        // Initialize custom rename pattern preview
        initializeRenamePreview();

        // Initialize custom move pattern preview
        initializeMovePreview();

        // Initialize file index status display
        setTimeout(updateIndexStatus, 1000);

        // Load current schedule configuration
        setTimeout(loadRebuildSchedule, 1500);

        // Clear cache button handler
        document.getElementById('clearCacheBtn').addEventListener('click', function () {
            const button = this;
            const originalText = button.innerHTML;

            button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Clearing...';
            button.disabled = true;

            fetch('/clear-cache', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.innerHTML = '<i class="bi bi-check"></i> Cleared!';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-success');
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-success');
                            button.classList.add('btn-warning');
                            button.disabled = false;
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Failed to clear cache');
                    }
                })
                .catch(error => {
                    button.innerHTML = '<i class="bi bi-x"></i> Error';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-danger');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-warning');
                        button.disabled = false;
                    }, 2000);
                });
        });

        // Show/hide weekday selector based on frequency
        document.getElementById('rebuildFrequency').addEventListener('change', function () {
            const weekdayContainer = document.getElementById('weekdaySelectContainer');
            if (this.value === 'weekly') {
                weekdayContainer.style.display = 'block';
            } else {
                weekdayContainer.style.display = 'none';
            }
        });

        // Show/hide sync weekday selector based on frequency
        document.getElementById('syncFrequency').addEventListener('change', function () {
            const weekdayContainer = document.getElementById('syncWeekdaySelectContainer');
            if (this.value === 'weekly') {
                weekdayContainer.style.display = 'block';
            } else {
                weekdayContainer.style.display = 'none';
            }
        });

        // Show/hide getcomics weekday selector based on frequency
        document.getElementById('getcomicsFrequency').addEventListener('change', function () {
            const weekdayContainer = document.getElementById('getcomicsWeekdaySelectContainer');
            if (this.value === 'weekly') {
                weekdayContainer.style.display = 'block';
            } else {
                weekdayContainer.style.display = 'none';
            }
        });

        // Load sync schedule on page load
        loadSyncSchedule();

        // Load getcomics schedule on page load
        loadGetcomicsSchedule();

        // Load Komga config on page load
        loadKomgaConfig();

        // Show/hide Komga weekday selector based on frequency
        document.getElementById('komgaSyncFrequency').addEventListener('change', function () {
            const weekdayGroup = document.getElementById('komgaWeekdayGroup');
            weekdayGroup.style.display = this.value === 'weekly' ? 'block' : 'none';
        });
    });

    // File Index Management Functions
    function rebuildFileIndex() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        // Show loading state
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Rebuilding Index...';
        button.disabled = true;

        fetch('/api/rebuild-file-index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Update index status display
                    updateIndexStatus();
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error rebuilding file index:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function updateIndexStatus() {
        const indexStatusEl = document.getElementById('indexStatus');
        const lastRebuildEl = document.getElementById('lastRebuild');

        if (indexStatusEl) {
            indexStatusEl.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Checking...';
        }

        fetch('/api/file-index-status', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (indexStatusEl) {
                    indexStatusEl.textContent = `${data.total_files || 0} files | ${data.total_directories || 0} directories`;
                }
                if (lastRebuildEl) {
                    if (data.last_rebuild) {
                        lastRebuildEl.textContent = data.last_rebuild;
                    } else {
                        lastRebuildEl.textContent = 'Never';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching index status:', error);
                if (indexStatusEl) {
                    indexStatusEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error';
                }
            });
    }

    function loadRebuildSchedule() {
        fetch('/api/get-rebuild-schedule', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const schedule = data.schedule;
                    document.getElementById('rebuildFrequency').value = schedule.frequency || 'disabled';
                    document.getElementById('rebuildTime').value = schedule.time || '02:00';
                    document.getElementById('rebuildWeekday').value = schedule.weekday || '0';

                    // Show weekday selector if weekly
                    const weekdayContainer = document.getElementById('weekdaySelectContainer');
                    if (schedule.frequency === 'weekly') {
                        weekdayContainer.style.display = 'block';
                    } else {
                        weekdayContainer.style.display = 'none';
                    }

                    // Update next scheduled display
                    const nextScheduledEl = document.getElementById('nextScheduled');
                    if (nextScheduledEl && data.next_run) {
                        nextScheduledEl.textContent = data.next_run;
                    } else if (nextScheduledEl) {
                        nextScheduledEl.textContent = 'Not scheduled';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading rebuild schedule:', error);
            });
    }

    function saveRebuildSchedule() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        button.innerHTML = '<i class="bi bi-floppy spin"></i> Saving...';
        button.disabled = true;

        const schedule = {
            frequency: document.getElementById('rebuildFrequency').value,
            time: document.getElementById('rebuildTime').value,
            weekday: document.getElementById('rebuildWeekday').value
        };

        fetch('/api/save-rebuild-schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedule)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Reload schedule to update next run time
                    setTimeout(loadRebuildSchedule, 500);
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving schedule:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    // Sync Schedule Functions
    function loadSyncSchedule() {
        fetch('/api/get-sync-schedule', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const schedule = data.schedule;
                    document.getElementById('syncFrequency').value = schedule.frequency || 'disabled';
                    document.getElementById('syncTime').value = schedule.time || '03:00';
                    document.getElementById('syncWeekday').value = schedule.weekday || '0';

                    // Show weekday selector if weekly
                    const weekdayContainer = document.getElementById('syncWeekdaySelectContainer');
                    if (schedule.frequency === 'weekly') {
                        weekdayContainer.style.display = 'block';
                    } else {
                        weekdayContainer.style.display = 'none';
                    }

                    // Update last sync display
                    const lastSyncEl = document.getElementById('lastSyncDisplay');
                    if (lastSyncEl) {
                        if (data.last_sync) {
                            lastSyncEl.innerHTML = `<i class="bi bi-clock me-1"></i>Last sync: ${data.last_sync}`;
                        } else {
                            lastSyncEl.innerHTML = '<i class="bi bi-clock me-1"></i>Last sync: Never';
                        }
                        if (data.next_run && data.next_run !== 'Not scheduled') {
                            lastSyncEl.innerHTML += ` | <i class="bi bi-calendar-event me-1"></i>Next: ${data.next_run}`;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading sync schedule:', error);
            });
    }

    function saveSyncSchedule() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        button.innerHTML = '<i class="bi bi-floppy spin"></i> Saving...';
        button.disabled = true;

        const schedule = {
            frequency: document.getElementById('syncFrequency').value,
            time: document.getElementById('syncTime').value,
            weekday: document.getElementById('syncWeekday').value
        };

        fetch('/api/save-sync-schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedule)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Reload schedule to update next run time
                    setTimeout(loadSyncSchedule, 500);
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving sync schedule:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function runSyncNow() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Syncing...';
        button.disabled = true;

        fetch('/api/run-sync-now', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error running sync:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    // GetComics Schedule Functions
    function loadGetcomicsSchedule() {
        // First check if weekly packs is enabled
        fetch('/api/get-weekly-packs-config', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(wpData => {
                const warningEl = document.getElementById('weeklyPacksWarning');
                const frequencyEl = document.getElementById('getcomicsFrequency');
                const timeEl = document.getElementById('getcomicsTime');
                const weekdayEl = document.getElementById('getcomicsWeekday');
                const saveBtn = document.querySelector('button[onclick="saveGetcomicsSchedule()"]');
                const runBtn = document.querySelector('button[onclick="runGetcomicsNow()"]');

                if (wpData.success && wpData.config && wpData.config.enabled) {
                    // Weekly packs is enabled - show warning and disable controls
                    if (warningEl) warningEl.classList.remove('d-none');
                    if (frequencyEl) frequencyEl.disabled = true;
                    if (timeEl) timeEl.disabled = true;
                    if (weekdayEl) weekdayEl.disabled = true;
                    if (saveBtn) saveBtn.disabled = true;
                    if (runBtn) runBtn.disabled = true;
                } else {
                    // Weekly packs is disabled - hide warning and enable controls
                    if (warningEl) warningEl.classList.add('d-none');
                    if (frequencyEl) frequencyEl.disabled = false;
                    if (timeEl) timeEl.disabled = false;
                    if (weekdayEl) weekdayEl.disabled = false;
                    if (saveBtn) saveBtn.disabled = false;
                    if (runBtn) runBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error checking weekly packs status:', error);
            });

        // Load the actual getcomics schedule
        fetch('/api/get-getcomics-schedule', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const schedule = data.schedule;
                    document.getElementById('getcomicsFrequency').value = schedule.frequency || 'disabled';
                    document.getElementById('getcomicsTime').value = schedule.time || '03:00';
                    document.getElementById('getcomicsWeekday').value = schedule.weekday || '0';

                    // Show weekday selector if weekly
                    const weekdayContainer = document.getElementById('getcomicsWeekdaySelectContainer');
                    if (schedule.frequency === 'weekly') {
                        weekdayContainer.style.display = 'block';
                    } else {
                        weekdayContainer.style.display = 'none';
                    }

                    // Update last run display
                    const lastRunEl = document.getElementById('lastGetcomicsDisplay');
                    if (lastRunEl) {
                        if (data.last_run) {
                            lastRunEl.innerHTML = `<i class="bi bi-clock me-1"></i>Last run: ${data.last_run}`;
                        } else {
                            lastRunEl.innerHTML = '<i class="bi bi-clock me-1"></i>Last run: Never';
                        }
                        if (data.next_run && data.next_run !== 'Not scheduled') {
                            lastRunEl.innerHTML += ` | <i class="bi bi-calendar-event me-1"></i>Next: ${data.next_run}`;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading getcomics schedule:', error);
            });
    }

    function saveGetcomicsSchedule() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        button.innerHTML = '<i class="bi bi-floppy spin"></i> Saving...';
        button.disabled = true;

        const schedule = {
            frequency: document.getElementById('getcomicsFrequency').value,
            time: document.getElementById('getcomicsTime').value,
            weekday: document.getElementById('getcomicsWeekday').value
        };

        fetch('/api/save-getcomics-schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedule)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadGetcomicsSchedule(); // Reload to show next run time
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving getcomics schedule:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function runGetcomicsNow() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;

        button.innerHTML = '<i class="bi bi-cloud-download spin"></i> Downloading...';
        button.disabled = true;

        fetch('/api/run-getcomics-now', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                console.error('Error running getcomics download:', error);
                showToast('Network error occurred', 'error');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    // =========================================
    // Komga Reading Sync Functions
    // =========================================

    function loadKomgaConfig() {
        fetch('/api/komga/config', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.config) {
                    const cfg = data.config;
                    document.getElementById('komgaServerUrl').value = cfg.server_url || '';
                    document.getElementById('komgaUsername').value = cfg.username || '';
                    // Don't populate password field if masked
                    if (cfg.password && cfg.password !== '***') {
                        document.getElementById('komgaPassword').value = cfg.password;
                    } else if (cfg.password === '***') {
                        document.getElementById('komgaPassword').placeholder = '********** (saved)';
                    }
                    renderKomgaLibraryMappings(cfg.library_mappings || []);
                    document.getElementById('komgaSyncFrequency').value = cfg.frequency || 'disabled';
                    document.getElementById('komgaSyncTime').value = cfg.time || '05:00';
                    document.getElementById('komgaSyncWeekday').value = cfg.weekday || '0';

                    // Show weekday selector if weekly
                    document.getElementById('komgaWeekdayGroup').style.display =
                        cfg.frequency === 'weekly' ? 'block' : 'none';

                    // Update status badge
                    updateKomgaStatusBadge(cfg);

                    // Load sync status
                    loadKomgaSyncStatus();
                }
            })
            .catch(error => {
                console.error('Error loading Komga config:', error);
            });
    }

    function renderKomgaLibraryMappings(mappings) {
        const container = document.getElementById('komgaLibraryMappings');
        if (!mappings || mappings.length === 0) {
            container.innerHTML = '<p class="text-muted small fst-italic">No libraries configured. Add libraries in the Libraries section first.</p>';
            return;
        }
        let html = '<div class="table-responsive"><table class="table table-sm align-middle mb-0">';
        html += '<thead><tr><th>CLU Library</th><th>CLU Path</th><th>Komga Path Prefix</th></tr></thead><tbody>';
        for (const m of mappings) {
            html += '<tr>';
            html += '<td>' + escapeHtml(m.library_name) + '</td>';
            html += '<td><code>' + escapeHtml(m.library_path) + '</code></td>';
            html += '<td><input type="text" class="form-control form-control-sm komga-prefix-input" '
                + 'data-library-id="' + m.library_id + '" '
                + 'value="' + escapeHtml(m.komga_path_prefix || '') + '" '
                + 'placeholder="/comics"></td>';
            html += '</tr>';
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function collectKomgaLibraryMappings() {
        const inputs = document.querySelectorAll('.komga-prefix-input');
        const mappings = [];
        inputs.forEach(input => {
            mappings.push({
                library_id: parseInt(input.dataset.libraryId),
                komga_path_prefix: input.value.trim()
            });
        });
        return mappings;
    }

    function updateKomgaStatusBadge(cfg) {
        const badge = document.getElementById('komgaStatusBadge');
        if (!cfg || !cfg.server_url) {
            badge.className = 'badge bg-secondary';
            badge.innerHTML = '<i class="bi bi-x-circle me-1"></i>Not Configured';
        } else if (cfg.password === '***' || cfg.password) {
            badge.className = 'badge bg-warning';
            badge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Not Verified';
        } else {
            badge.className = 'badge bg-secondary';
            badge.innerHTML = '<i class="bi bi-x-circle me-1"></i>No Credentials';
        }
    }

    function loadKomgaSyncStatus() {
        fetch('/api/komga/sync/status', {
            headers: { 'Cache-Control': 'no-cache' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusDiv = document.getElementById('komgaSyncStatus');
                    const hasSync = data.last_sync || data.total_synced_read > 0 || data.total_synced_progress > 0;

                    if (hasSync) {
                        statusDiv.style.display = 'block';
                        document.getElementById('komgaLastSync').textContent =
                            data.last_sync ? new Date(data.last_sync).toLocaleString() : 'Never';
                        document.getElementById('komgaReadCount').textContent = data.total_synced_read || 0;
                        document.getElementById('komgaProgressCount').textContent = data.total_synced_progress || 0;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading Komga sync status:', error);
            });
    }

    async function saveKomgaConfig() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const data = {
            server_url: document.getElementById('komgaServerUrl').value.trim(),
            username: document.getElementById('komgaUsername').value.trim(),
            password: document.getElementById('komgaPassword').value || '***',
            library_mappings: collectKomgaLibraryMappings(),
            enabled: true,
            frequency: document.getElementById('komgaSyncFrequency').value,
            time: document.getElementById('komgaSyncTime').value,
            weekday: parseInt(document.getElementById('komgaSyncWeekday').value)
        };

        try {
            const response = await fetch('/api/komga/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast('Komga configuration saved', 'success');
                loadKomgaConfig();
            } else {
                showToast('Error: ' + (result.error || 'Failed to save'), 'error');
            }
        } catch (e) {
            showToast('Error saving Komga config: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    async function testKomgaConnection() {
        const btn = document.getElementById('komgaTestBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';

        try {
            const response = await fetch('/api/komga/test', { method: 'POST' });
            const data = await response.json();

            const badge = document.getElementById('komgaStatusBadge');

            if (data.success && data.valid) {
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Connected!';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-success');
                badge.className = 'badge bg-success';
                badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>Connected';
                showToast('Komga connection successful!', 'success');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-info');
                    btn.disabled = false;
                }, 2000);
            } else {
                btn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Failed';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-danger');
                badge.className = 'badge bg-warning';
                badge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Test Failed';
                showToast('Connection failed: ' + (data.error || 'Unknown error'), 'error');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-info');
                    btn.disabled = false;
                }, 2000);
            }
        } catch (e) {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            showToast('Error testing connection: ' + e.message, 'error');
        }
    }

    async function syncKomgaNow() {
        const btn = document.getElementById('komgaSyncBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Syncing...';

        try {
            const response = await fetch('/api/komga/sync', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                showToast('Komga sync started in background', 'success');
                // Poll for completion after a delay
                setTimeout(() => {
                    loadKomgaSyncStatus();
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 3000);
            } else {
                showToast('Error: ' + (data.error || 'Failed to start sync'), 'error');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (e) {
            showToast('Error starting sync: ' + e.message, 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Custom Rename Pattern Preview Functions
    function initializeRenamePreview() {
        const patternInput = document.getElementById('customRenamePattern');
        const previewElement = document.getElementById('renamePreview');

        if (patternInput && previewElement) {
            // Add event listeners for live preview
            patternInput.addEventListener('input', updateRenamePreview);
            patternInput.addEventListener('change', updateRenamePreview);

            // Initial preview
            updateRenamePreview();
        }
    }

    function updateRenamePreview() {
        const patternInput = document.getElementById('customRenamePattern');
        const previewElement = document.getElementById('renamePreview');

        if (!patternInput || !previewElement) return;

        const pattern = patternInput.value.trim();
        if (!pattern) {
            previewElement.textContent = 'Enter a pattern to see preview...';
            return;
        }

        // Sample values for preview
        const sampleValues = {
            publisher: 'Marvel',
            series_name: 'Spider-Man 2099',
            volume_number: 'v2',
            year: '1992',
            issue_number: '044',
            issue_title: 'The Last Dance'
        };

        try {
            const preview = applyCustomPattern(sampleValues, pattern);
            previewElement.textContent = preview + '.cbz';
        } catch (error) {
            previewElement.textContent = 'Invalid pattern';
        }
    }

    function applyCustomPattern(values, pattern) {
        // Simple pattern replacement for preview
        let result = pattern;

        // Replace variables with sample values
        result = result.replace(/\{publisher\}/g, values.publisher || '');
        result = result.replace(/\{series_name\}/g, values.series_name || '');
        result = result.replace(/\{volume_number\}/g, values.volume_number || '');
        result = result.replace(/\{year\}/g, values.year || '');  // For rename patterns
        result = result.replace(/\{start_year\}/g, values.start_year || '');  // For move patterns
        result = result.replace(/\{issue_number\}/g, values.issue_number || '');
        result = result.replace(/\{issue_title\}/g, values.issue_title || '');

        // Clean up extra spaces
        result = result.replace(/\s+/g, ' ').trim();

        // Remove empty parentheses
        result = result.replace(/\s*\(\s*\)/g, '').trim();

        // Remove orphaned separators (e.g., trailing " - " when issue_title is empty)
        result = result.replace(/\s*-\s*(?=\(|$)/g, ' ').replace(/\s+/g, ' ').trim();

        return result;
    }

    // Custom Move Pattern Preview Functions
    function initializeMovePreview() {
        const patternInput = document.getElementById('customMovePattern');
        const previewElement = document.getElementById('movePreview');

        if (patternInput && previewElement) {
            // Add event listeners for live preview
            patternInput.addEventListener('input', updateMovePreview);
            patternInput.addEventListener('change', updateMovePreview);

            // Initial preview
            updateMovePreview();
        }
    }

    function updateMovePreview() {
        const patternInput = document.getElementById('customMovePattern');
        const previewElement = document.getElementById('movePreview');

        if (!patternInput || !previewElement) return;

        const pattern = patternInput.value.trim();
        if (!pattern) {
            previewElement.textContent = 'Enter a pattern to see preview...';
            return;
        }

        // Sample values for preview
        const sampleValues = {
            publisher: 'Marvel',
            series_name: 'Spider-Man 2099',
            volume_number: 'v2',
            start_year: '1992',
            issue_number: '044'
        };

        try {
            const preview = applyCustomPattern(sampleValues, pattern);
            previewElement.textContent = preview + '/';
        } catch (error) {
            previewElement.textContent = 'Invalid pattern';
        }
    }

    // Theme Preview Functions
    function initializeThemePreview() {
        const themeSelect = document.getElementById('bootstrapTheme');
        if (themeSelect) {
            themeSelect.addEventListener('change', updateThemePreview);
        }
    }

    function updateThemePreview() {
        const themeSelect = document.getElementById('bootstrapTheme');
        const previewImg = document.getElementById('themePreviewImg');
        const previewName = document.getElementById('themePreviewName');

        if (!themeSelect || !previewImg || !previewName) return;

        const theme = themeSelect.value;
        const themeName = themeSelect.options[themeSelect.selectedIndex].text;

        // Update thumbnail image
        previewImg.src = `https://bootswatch.com/${theme}/thumbnail.png`;

        // Update theme name (remove "(Dark)" suffix for display)
        previewName.textContent = themeName.replace(' (Dark)', '');
    }

    // Initialize theme preview on page load
    document.addEventListener('DOMContentLoaded', function () {
        initializeThemePreview();
    });
</script>

<script>
    function updateModelOptions() {
        const provider = document.getElementById('recProvider').value;
        const modelSelect = document.getElementById('recModel');
        const currentModel = "{{ rec_model }}";

        // Clear existing options
        modelSelect.innerHTML = '';

        let models = [];

        if (provider === 'gemini') {
            models = [
                { value: 'gemini-3-flash', text: 'Gemini 3 Flash (Latest)' },
                { value: 'gemini-2.5-pro', text: 'Gemini 2.5 Pro' },
                { value: 'gemini-2.0-flash', text: 'Gemini 2.0 Flash' }
            ];
        } else if (provider === 'openai') {
            models = [
                { value: 'gpt-4.1', text: 'GPT-4.1 (Smartest)' },
                { value: 'gpt-4.1-mini', text: 'GPT-4.1 Mini' },
                { value: 'gpt-4o', text: 'GPT-4o (Legacy)' }
            ];
        } else if (provider === 'anthropic') {
            models = [
                { value: 'claude-sonnet-4-5-20250929', text: 'Claude Sonnet 4.5' },
                { value: 'claude-3-haiku-20240307', text: 'Claude Haiku 3' }
            ];
        }

        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.text = model.text;
            if (model.value === currentModel) {
                option.selected = true;
            }
            modelSelect.appendChild(option);
        });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updateModelOptions);
</script>

<script>
    // Password visibility toggle
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.toggle-password').forEach(function (button) {
            button.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });
    });
</script>

<!-- Library Modal -->
<div class="modal fade" id="libraryModal" tabindex="-1" aria-labelledby="libraryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="libraryModalLabel">Add Library</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="libraryEditId">
                <div class="mb-3">
                    <label for="libraryName" class="form-label">Library Name</label>
                    <input type="text" class="form-control" id="libraryName"
                        placeholder="e.g., Comics, Manga, Graphic Novels">
                    <small class="form-text text-muted">A friendly name for this library</small>
                </div>
                <div class="mb-3">
                    <label for="libraryPath" class="form-label">Library Path</label>
                    <input type="text" class="form-control" id="libraryPath" placeholder="e.g., /data, /comics, /manga">
                    <small class="form-text text-muted">The mounted path inside the Docker container</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLibrary()">Save Library</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Library Management Functions
    let libraryModal;

    document.addEventListener('DOMContentLoaded', function () {
        libraryModal = new bootstrap.Modal(document.getElementById('libraryModal'));
        loadLibraries();
        loadProviders();
        loadLibraryProviders();
    });

    async function loadLibraries() {
        const container = document.getElementById('librariesList');
        try {
            const response = await fetch('/api/libraries?all=true');
            const data = await response.json();

            if (!data.success) {
                container.innerHTML = '<div class="alert alert-danger">Failed to load libraries</div>';
                return;
            }

            if (data.libraries.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        No libraries configured. Add a library to get started.
                    </div>`;
                return;
            }

            let html = '<div class="list-group">';
            for (const lib of data.libraries) {
                const enabledBadge = lib.enabled
                    ? '<span class="badge bg-success">Enabled</span>'
                    : '<span class="badge bg-secondary">Disabled</span>';
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(lib.name)}</strong>
                            <span class="text-muted ms-2">${escapeHtml(lib.path)}</span>
                            ${enabledBadge}
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" onclick="editLibrary(${lib.id}, '${escapeHtml(lib.name)}', '${escapeHtml(lib.path)}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-${lib.enabled ? 'warning' : 'success'}" onclick="toggleLibrary(${lib.id}, ${!lib.enabled})">
                                <i class="bi bi-${lib.enabled ? 'pause' : 'play'}"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteLibrary(${lib.id}, '${escapeHtml(lib.name)}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<div class="alert alert-danger">Error loading libraries: ' + e.message + '</div>';
        }
    }

    function showAddLibraryModal() {
        document.getElementById('libraryModalLabel').textContent = 'Add Library';
        document.getElementById('libraryEditId').value = '';
        document.getElementById('libraryName').value = '';
        document.getElementById('libraryPath').value = '';
        libraryModal.show();
    }

    function editLibrary(id, name, path) {
        document.getElementById('libraryModalLabel').textContent = 'Edit Library';
        document.getElementById('libraryEditId').value = id;
        document.getElementById('libraryName').value = name;
        document.getElementById('libraryPath').value = path;
        libraryModal.show();
    }

    async function saveLibrary() {
        const id = document.getElementById('libraryEditId').value;
        const name = document.getElementById('libraryName').value.trim();
        const path = document.getElementById('libraryPath').value.trim();

        if (!name || !path) {
            alert('Please enter both name and path');
            return;
        }

        try {
            let response;
            if (id) {
                // Update existing
                response = await fetch(`/api/libraries/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, path })
                });
            } else {
                // Add new
                response = await fetch('/api/libraries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, path })
                });
            }

            const data = await response.json();
            if (data.success) {
                libraryModal.hide();
                loadLibraries();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error saving library: ' + e.message);
        }
    }

    async function toggleLibrary(id, enabled) {
        try {
            const response = await fetch(`/api/libraries/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });
            const data = await response.json();
            if (data.success) {
                loadLibraries();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error toggling library: ' + e.message);
        }
    }

    async function deleteLibrary(id, name) {
        if (!confirm(`Are you sure you want to delete the library "${name}"?\n\nThis will not delete any files, only the library configuration.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/libraries/${id}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            if (data.success) {
                loadLibraries();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (e) {
            alert('Error deleting library: ' + e.message);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // =========================================
    // Metadata Provider Management Functions
    // =========================================

    async function loadProviders() {
        const container = document.getElementById('providersCredentialsList');
        try {
            const response = await fetch('/api/providers');
            const data = await response.json();

            if (!data.success) {
                container.innerHTML = '<div class="alert alert-danger">Failed to load providers</div>';
                return;
            }

            if (data.providers.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No providers available</div>';
                return;
            }

            let html = '<div class="row">';
            for (const provider of data.providers) {
                // Status badge logic - different for auth-free providers
                let statusBadge;
                if (provider.is_valid) {
                    statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Connected</span>';
                } else if (!provider.requires_auth) {
                    statusBadge = provider.has_credentials
                        ? '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Test Failed</span>'
                        : '<span class="badge bg-info"><i class="bi bi-globe me-1"></i>Public API</span>';
                } else {
                    statusBadge = provider.has_credentials
                        ? '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Not Verified</span>'
                        : '<span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not Configured</span>';
                }

                const lastTested = provider.last_tested
                    ? `<small class="text-muted">Last tested: ${new Date(provider.last_tested).toLocaleString()}</small>`
                    : '';

                // Different card body for auth-free vs auth-required providers
                let cardBody;
                if (!provider.requires_auth) {
                    // Auth-free provider - no credential fields, just test button
                    cardBody = `
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle me-1"></i>No authentication required - public API
                        </p>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn ${provider.is_valid ? 'btn-outline-info' : 'btn-primary'} btn-sm" onclick="testProviderConnection('${provider.type}')">
                                <i class="bi bi-lightning me-1"></i>${provider.is_valid ? 'Test' : 'Enable Provider'}
                            </button>
                            ${provider.has_credentials ? `
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteProviderCredentials('${provider.type}')">
                                <i class="bi bi-trash me-1"></i>Remove
                            </button>` : ''}
                        </div>`;
                } else {
                    // Auth-required provider - show credential form
                    cardBody = `
                        <form id="provider-form-${provider.type}" onsubmit="saveProviderCredentials('${provider.type}', event); return false;">
                            ${generateProviderFields(provider)}
                            <div class="mt-3 d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-floppy me-1"></i>Save
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="testProviderConnection('${provider.type}')">
                                    <i class="bi bi-lightning me-1"></i>Test
                                </button>
                                ${provider.has_credentials ? `
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteProviderCredentials('${provider.type}')">
                                    <i class="bi bi-trash me-1"></i>Delete
                                </button>` : ''}
                            </div>
                        </form>`;
                }

                const metronAttribution = provider.type === 'metron' ? `
                            <div class="card-footer text-muted small">
                                Metadata provided by <a href="https://metron.cloud" target="_blank">Metron</a><br>
                                Help support Metron with a <a href="https://opencollective.com/metron" target="_blank">donation</a>
                            </div>` : '';

                const gcdExtra = provider.type === 'gcd' ? `
                    <div class="mt-3 pt-3 border-top">
                        <label for="gcdLanguages" class="form-label">Metadata Languages</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="gcdLanguages" class="form-control form-control-sm"
                                   placeholder="en" value="">
                            <button type="button" class="btn btn-primary btn-sm" onclick="saveGcdLanguages()">
                                <i class="bi bi-floppy me-1"></i>Save
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Comma-separated language codes (e.g., "en,es,fr"). Default: "en"
                        </small>
                    </div>` : '';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>${escapeHtml(provider.name)}</strong>
                                ${statusBadge}
                            </div>
                            <div class="card-body">
                                ${cardBody}
                                ${gcdExtra}
                                ${lastTested}
                            </div>
                            ${metronAttribution}
                            <div class="card-footer text-muted small">
                                Rate limit: ${provider.rate_limit} requests/minute
                            </div>
                        </div>
                    </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
            // Reinitialize password toggle buttons for dynamically created elements
            initPasswordToggles(container);
            // Load GCD language preference into the field
            loadGcdLanguages();
        } catch (e) {
            container.innerHTML = '<div class="alert alert-danger">Error loading providers: ' + escapeHtml(e.message) + '</div>';
        }
    }

    async function loadGcdLanguages() {
        const input = document.getElementById('gcdLanguages');
        if (!input) return;
        try {
            const resp = await fetch('/api/preferences/gcd_metadata_languages');
            const data = await resp.json();
            if (data.success && data.value) {
                input.value = data.value;
            } else {
                input.value = 'en';
            }
        } catch (e) {
            input.value = 'en';
        }
    }

    async function saveGcdLanguages() {
        const input = document.getElementById('gcdLanguages');
        if (!input) return;
        const value = input.value.trim() || 'en';
        try {
            const resp = await fetch('/api/preferences/gcd_metadata_languages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value, category: 'metadata' })
            });
            const data = await resp.json();
            if (data.success) {
                showToast('GCD language preference saved', 'success');
            } else {
                showToast('Error saving GCD languages: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (e) {
            showToast('Error saving GCD languages: ' + e.message, 'error');
        }
    }

    function initPasswordToggles(container) {
        container.querySelectorAll('.toggle-password').forEach(function (button) {
            button.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });
    }

    function generateProviderFields(provider) {
        let html = '';
        for (const field of provider.auth_fields) {
            const fieldId = `provider-${provider.type}-${field}`;
            const fieldLabel = field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            const isPassword = field.toLowerCase().includes('password') || field.toLowerCase().includes('key') || field.toLowerCase().includes('api');
            const inputType = isPassword ? 'password' : 'text';
            const maskedValue = provider.credentials_masked && provider.credentials_masked[field] ? provider.credentials_masked[field] : '';

            html += `
                <div class="mb-2">
                    <label for="${fieldId}" class="form-label small">${fieldLabel}</label>
                    <div class="input-group input-group-sm">
                        <input type="${inputType}" class="form-control ${isPassword ? 'password-field' : ''}"
                               id="${fieldId}" name="${field}" placeholder="${maskedValue || 'Enter ' + fieldLabel.toLowerCase()}"
                               ${provider.has_credentials ? 'data-has-existing="true"' : ''}
                               autocomplete="${field.toLowerCase().includes('password') ? 'current-password' : 'off'}">
                        ${isPassword ? `
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="${fieldId}">
                            <i class="bi bi-eye"></i>
                        </button>` : ''}
                    </div>
                </div>`;
        }
        return html;
    }

    async function saveProviderCredentials(providerType, event) {
        // Prevent form submission
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        const form = document.getElementById(`provider-form-${providerType}`);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnHtml = submitBtn.innerHTML;

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        const formData = new FormData(form);
        const credentials = {};

        for (const [key, value] of formData.entries()) {
            if (value.trim()) {
                credentials[key] = value.trim();
            }
        }

        // Check if any credentials were provided
        if (Object.keys(credentials).length === 0) {
            showToast('Please enter at least one credential field', 'warning');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHtml;
            return false;
        }

        try {
            const response = await fetch(`/api/providers/${providerType}/credentials`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            });
            const data = await response.json();

            if (data.success) {
                showToast(`Credentials saved for ${providerType}`, 'success');
                // Clear form fields after successful save
                form.querySelectorAll('input').forEach(input => input.value = '');
                loadProviders();
                loadLibraryProviders();
            } else {
                showToast('Error: ' + (data.error || 'Failed to save credentials'), 'error');
            }
        } catch (e) {
            showToast('Error saving credentials: ' + e.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHtml;
        }
        return false;
    }

    async function testProviderConnection(providerType) {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';

        try {
            const response = await fetch(`/api/providers/${providerType}/test`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success && data.valid) {
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Success!';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-success');
                showToast(`Connection to ${providerType} successful!`, 'success');
                setTimeout(() => {
                    loadProviders();
                }, 1500);
            } else {
                btn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Failed';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-danger');
                showToast('Connection test failed: ' + (data.error || 'Unknown error'), 'error');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-info');
                    btn.disabled = false;
                }, 2000);
            }
        } catch (e) {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            showToast('Error testing connection: ' + e.message, 'error');
        }
    }

    async function deleteProviderCredentials(providerType) {
        if (!confirm('Are you sure you want to delete credentials for this provider?')) {
            return;
        }

        try {
            const response = await fetch(`/api/providers/${providerType}/credentials`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.success) {
                showToast(`Credentials deleted for ${providerType}`, 'success');
                loadProviders();
                loadLibraryProviders();
            } else {
                showToast('Error: ' + (data.error || 'Failed to delete credentials'), 'error');
            }
        } catch (e) {
            showToast('Error deleting credentials: ' + e.message, 'error');
        }
    }

    async function loadLibraryProviders() {
        const container = document.getElementById('libraryProvidersList');
        try {
            // Get libraries first
            const libResponse = await fetch('/api/libraries?all=true');
            const libData = await libResponse.json();

            if (!libData.success || libData.libraries.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Add libraries first to configure their metadata providers.</div>';
                return;
            }

            // Get available providers
            const provResponse = await fetch('/api/providers');
            const provData = await provResponse.json();

            if (!provData.success) {
                container.innerHTML = '<div class="alert alert-danger">Failed to load providers</div>';
                return;
            }

            // Filter to only configured/enabled providers (has_credentials includes auth-free providers that were tested)
            const configuredProviders = provData.providers.filter(p => p.has_credentials || p.is_valid);
            if (configuredProviders.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No providers enabled yet. Configure credentials for auth-required providers, or click "Enable Provider" for public API providers above.</div>';
                return;
            }

            let html = '<div class="accordion" id="libraryProvidersAccordion">';
            for (const lib of libData.libraries) {
                // Get library's current provider config
                const libProvResponse = await fetch(`/api/libraries/${lib.id}/providers`);
                const libProvData = await libProvResponse.json();
                const libraryProviders = libProvData.success ? libProvData.providers : [];

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-lib-${lib.id}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse-lib-${lib.id}" aria-expanded="false" aria-controls="collapse-lib-${lib.id}">
                                <strong>${escapeHtml(lib.name)}</strong>
                                <span class="badge bg-info ms-2">${libraryProviders.length} provider(s)</span>
                            </button>
                        </h2>
                        <div id="collapse-lib-${lib.id}" class="accordion-collapse collapse" aria-labelledby="heading-lib-${lib.id}"
                             data-bs-parent="#libraryProvidersAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small">Select and order metadata providers for this library. Higher priority providers are tried first.</p>
                                <div id="library-providers-${lib.id}">
                                    ${generateLibraryProviderCheckboxes(lib.id, configuredProviders, libraryProviders)}
                                </div>
                                <button type="button" class="btn btn-primary btn-sm mt-2"
                                        onclick="saveLibraryProviders(${lib.id})">
                                    <i class="bi bi-floppy me-1"></i>Save Provider Settings
                                </button>
                            </div>
                        </div>
                    </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<div class="alert alert-danger">Error loading library providers: ' + escapeHtml(e.message) + '</div>';
        }
    }

    function generateLibraryProviderCheckboxes(libraryId, availableProviders, currentProviders) {
        let html = '<div class="list-group">';

        // Create a map of current providers with their priorities
        const currentMap = {};
        currentProviders.forEach((p, idx) => {
            currentMap[p.provider_type] = { enabled: p.enabled, priority: p.priority ?? idx };
        });

        // Sort available providers: enabled first (by priority), then disabled
        const sortedProviders = [...availableProviders].sort((a, b) => {
            const aEnabled = currentMap[a.type]?.enabled;
            const bEnabled = currentMap[b.type]?.enabled;
            if (aEnabled && !bEnabled) return -1;
            if (!aEnabled && bEnabled) return 1;
            if (aEnabled && bEnabled) {
                return (currentMap[a.type]?.priority ?? 999) - (currentMap[b.type]?.priority ?? 999);
            }
            return 0;
        });

        for (const provider of sortedProviders) {
            const isEnabled = currentMap[provider.type]?.enabled ?? false;
            const priority = currentMap[provider.type]?.priority ?? 999;

            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center"
                     data-provider-type="${provider.type}" data-priority="${priority}">
                    <div class="form-check">
                        <input class="form-check-input library-provider-check" type="checkbox"
                               id="lib-${libraryId}-prov-${provider.type}"
                               data-library-id="${libraryId}" data-provider-type="${provider.type}"
                               ${isEnabled ? 'checked' : ''}>
                        <label class="form-check-label" for="lib-${libraryId}-prov-${provider.type}">
                            ${escapeHtml(provider.name)}
                            ${provider.is_valid ? '<i class="bi bi-check-circle-fill text-success ms-1"></i>' : ''}
                        </label>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="moveProviderUp(${libraryId}, '${provider.type}')" title="Move up">
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="moveProviderDown(${libraryId}, '${provider.type}')" title="Move down">
                            <i class="bi bi-arrow-down"></i>
                        </button>
                    </div>
                </div>`;
        }
        html += '</div>';
        return html;
    }

    function moveProviderUp(libraryId, providerType) {
        const container = document.getElementById(`library-providers-${libraryId}`);
        const items = container.querySelectorAll('.list-group-item');
        const itemsArray = Array.from(items);
        const currentIndex = itemsArray.findIndex(item => item.dataset.providerType === providerType);

        if (currentIndex > 0) {
            const currentItem = itemsArray[currentIndex];
            const previousItem = itemsArray[currentIndex - 1];
            currentItem.parentNode.insertBefore(currentItem, previousItem);
        }
    }

    function moveProviderDown(libraryId, providerType) {
        const container = document.getElementById(`library-providers-${libraryId}`);
        const items = container.querySelectorAll('.list-group-item');
        const itemsArray = Array.from(items);
        const currentIndex = itemsArray.findIndex(item => item.dataset.providerType === providerType);

        if (currentIndex < itemsArray.length - 1) {
            const currentItem = itemsArray[currentIndex];
            const nextItem = itemsArray[currentIndex + 1];
            currentItem.parentNode.insertBefore(nextItem, currentItem);
        }
    }

    async function saveLibraryProviders(libraryId) {
        const container = document.getElementById(`library-providers-${libraryId}`);
        const items = container.querySelectorAll('.list-group-item');
        const providers = [];

        items.forEach((item, index) => {
            const providerType = item.dataset.providerType;
            const checkbox = item.querySelector('.library-provider-check');
            providers.push({
                provider_type: providerType,
                priority: index,
                enabled: checkbox.checked
            });
        });

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        try {
            const response = await fetch(`/api/libraries/${libraryId}/providers`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ providers })
            });
            const data = await response.json();

            if (data.success) {
                showToast('Library provider settings saved', 'success');
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Saved!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 1500);
            } else {
                showToast('Error: ' + (data.error || 'Failed to save settings'), 'error');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (e) {
            showToast('Error saving library providers: ' + e.message, 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}