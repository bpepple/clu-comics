{% extends "base.html" %}

{% block title %}{{ series.name }} - Series{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/files.css') }}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5" id="series">
        <div class="col-12">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Cover Image -->
                        <div class="col-md-3">
                            {% if first_issue_image %}
                            <img src="{{ first_issue_image }}" alt="{{ series.name }}"
                                class="img-fluid rounded shadow-sm">
                            {% else %}
                            <div class="bg-secondary rounded d-flex align-items-center justify-content-center">
                                <i class="bi bi-journal-text text-white" style="font-size: 3rem; opacity: 0.5;"></i>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Series Info -->
                        <div class="col-md-7">
                            <h2 class="display-6 fw-bold mb-3">{{ series.name }}</h2>
                            <p class="lead mb-4">{{ series.desc or 'No description available.' }}</p>

                            <div class="row g-3 text-muted">
                                <div class="col-6 col-md-5">
                                    <small class="text-uppercase fw-bold d-block mb-1"
                                        style="font-size: 0.75rem;">Publisher</small>
                                    <span>{{ series.publisher.name if series.publisher else '-' }}</span>
                                </div>
                                <div class="col-6 col-md-4">
                                    <small class="text-uppercase fw-bold d-block mb-1"
                                        style="font-size: 0.75rem;">Status</small>
                                    <span>{{ series.status }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-uppercase fw-bold d-block mb-1" style="font-size: 0.75rem;">Issue
                                        Count</small>
                                    <span>{{ series.issue_count }}</span>
                                </div>
                                <div class="col-6 col-md-5">
                                    <small class="text-uppercase fw-bold d-block mb-1"
                                        style="font-size: 0.75rem;">Volume</small>
                                    <span>{{ series.volume }}</span>
                                </div>
                                <div class="col-6 col-md-4">
                                    <small class="text-uppercase fw-bold d-block mb-1" style="font-size: 0.75rem;">Year
                                        Began</small>
                                    <span>{{ series.year_began }}</span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-uppercase fw-bold d-block mb-1" style="font-size: 0.75rem;">Year
                                        Ended</small>
                                    <span>{{ series.year_ended or series.year_end or 'Ongoing' }}</span>
                                </div>
                                <div class="col-6 col-md-5">
                                    <small class="text-uppercase fw-bold d-block mb-1"
                                        style="font-size: 0.75rem;">Metron ID</small>
                                    <a href="https://metron.cloud/series/{{ series.id }}/" target="_blank"
                                        class="font-monospace text-decoration-none">{{ series.id }}</a>
                                </div>
                                <div class="col-6 col-md-4">
                                    <small class="text-uppercase fw-bold d-block mb-1"
                                        style="font-size: 0.75rem;">ComicVine ID</small>
                                    {% if series.cv_id %}
                                    <a href="https://comicvine.gamespot.com/volume/4050-{{ series.cv_id }}/"
                                        target="_blank" class="font-monospace text-decoration-none">{{ series.cv_id
                                        }}</a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                                <div class="col-6 col-md-3">
                                    <small class="text-uppercase fw-bold d-block mb-1" style="font-size: 0.75rem;">GCD
                                        ID</small>
                                    {% if series.gcd_id %}
                                    <a href="https://www.comics.org/series/{{ series.gcd_id }}/" target="_blank"
                                        class="font-monospace text-decoration-none">{{ series.gcd_id }}</a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Actions -->
                        <div class="col-md-2 d-flex flex-column align-items-md-end justify-content-start gap-2">
                            <button onclick="history.back()" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </button>
                            <button onclick="forceRefresh()" class="btn btn-outline-info w-100" title="Force refresh from Metron API">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                            <a href="https://metron.cloud/series/{{ series.id }}/" target="_blank"
                                class="btn btn-outline-primary w-100">
                                <i class="bi bi-box-arrow-up-right me-1"></i>View on Metron
                            </a>
                            {% if series.cv_id %}
                            <a href="https://comicvine.gamespot.com/volume/4050-{{ series.cv_id }}/" target="_blank"
                                class="btn btn-outline-info w-100">
                                <i class="bi bi-box-arrow-up-right me-1"></i>ComicVine
                            </a>
                            {% endif %}
                            {% if series.gcd_id %}
                            <a href="https://www.comics.org/series/{{ series.gcd_id }}/" target="_blank"
                                class="btn btn-outline-warning w-100">
                                <i class="bi bi-box-arrow-up-right me-1"></i>GCD
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show shadow-sm"
            role="alert">
            <div class="d-flex align-items-center">
                <i
                    class="bi bi-{{ 'check-circle-fill' if category == 'success' else 'exclamation-triangle-fill' }} me-2"></i>
                {{ message }}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Mapping Section -->
    <div class="row mb-4" id="mapping">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-folder2-open me-2"></i>Collection Mapping</h5>
                            <p class="text-muted mb-0" id="mapped-path-display">
                                {% if mapped_path %}
                                <span class="text-success"><i class="bi bi-check-circle me-1"></i>{{ mapped_path
                                    }}</span>
                                {% else %}
                                <span class="text-muted">Not mapped to local collection</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex gap-2">
                                {% if mapped_path %}
                                <button class="btn btn-outline-danger" onclick="removeMappingConfirm()">
                                    <i class="bi bi-x-circle me-1"></i>Remove
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-primary" onclick="openMappingModal()">
                                    <i class="bi bi-folder-symlink me-1"></i>
                                    {% if mapped_path %}Change{% else %}Map{% endif %} Location
                                </button>
                                {% if not mapped_path %}
                                <button class="btn btn-success" onclick="openSubscribeModal()">
                                    <i class="bi bi-bookmark-plus me-1"></i>Subscribe
                                </button>
                                {% endif %}
                                {% if mapped_path %}
                                <button class="btn btn-outline-secondary" onclick="syncSeries()" id="sync-btn"
                                    title="Check API for New Issues">
                                    <i class="bi bi-arrow-repeat me-1"></i>API Sync
                                </button>
                                <button class="btn btn-outline-success" onclick="refreshCollectionStatus()"
                                    id="refresh-btn" title="Check Collection for New Issues">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                                {% endif %}
                            </div>
                            {% if last_synced_at %}
                            <small class="text-muted" id="last-synced-display">
                                <i class="bi bi-clock me-1"></i>Synced: {{ last_synced_at }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress indicator -->
    <div class="row p-3" id="progress-container" style="display: none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="bi bi-hourglass-split me-2"></i>Processing Progress</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="hideProgressIndicator()"
                        aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                            aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    <div id="progress-text" class="text-muted">Initializing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Issues -->
    {% if issues %}
    <div class="card shadow-sm border-0" id="issues">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col" class="ps-4">Issue Number</th>
                            <th scope="col">Store Date</th>
                            <th scope="col" class="text-end pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in issues|reverse %}
                        {% set status = issue_status.get(issue.number|string, {}) if issue_status else {} %}
                        {% set manual = manual_status.get(issue.number|string, {}) if manual_status else {} %}
                        {% set has_manual = manual.get('status') %}
                        {% set is_upcoming = issue.store_date and (issue.store_date|string) > today %}
                        <tr data-issue-number="{{ issue.number }}"
                            class="{% if mapped_path %}{% if status.get('found') or has_manual %}table-success{% elif is_upcoming %}table-info{% else %}table-danger{% endif %}{% endif %}">
                            <td class="ps-4 fw-bold">
                                {% if mapped_path %}
                                {% if status.get('found') %}
                                <i class="bi bi-check-circle-fill text-success me-1" title="Found in collection"></i>
                                {% elif has_manual == 'owned' %}
                                <i class="bi bi-bookmark-check-fill text-success me-1"
                                    title="Owned{% if manual.notes %}: {{ manual.notes }}{% endif %}"></i>
                                {% elif has_manual == 'skipped' %}
                                <i class="bi bi-skip-forward-circle-fill text-success me-1"
                                    title="Skipped{% if manual.notes %}: {{ manual.notes }}{% endif %}"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-danger me-1" title="Not found"></i>
                                {% endif %}
                                {% endif %}
                                #{{ '%03d'|format(issue.number|int) if issue.number|int|string == issue.number|string
                                else issue.number }}
                                {% if mapped_path and not status.get('found') and not has_manual and not is_upcoming %}
                                <span class="badge bg-warning text-dark ms-2">Wanted</span>
                                {% endif %}
                            </td>
                            <td>{{ issue.store_date or '-' }}</td>
                            <td class="text-end pe-4">
                                {% if mapped_path and status.get('found') and status.get('file_path') %}
                                <!-- Found in collection - show file actions -->
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-info text-info"
                                        onclick="viewIssueFile('{{ status.get('file_path')|replace('\\', '/')|e }}', '{{ issue.number }}')"
                                        title="View CBZ Info">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="editIssueFile('{{ status.get('file_path')|replace('\\', '/')|e }}')"
                                        title="Edit CBZ">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm btn-outline-secondary" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow">
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="executeIssueScript('crop', '{{ status.get('file_path')|replace('\\', '/')|e }}'); return false;">
                                                    <i class="bi bi-crop me-2"></i>Crop Cover
                                                </a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="executeIssueScript('remove', '{{ status.get('file_path')|replace('\\', '/')|e }}'); return false;">
                                                    <i class="bi bi-file-minus me-2"></i>Remove 1st Image
                                                </a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="executeIssueScript('single_file', '{{ status.get('file_path')|replace('\\', '/')|e }}'); return false;">
                                                    <i class="bi bi-hammer me-2"></i>Rebuild
                                                </a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="executeIssueScript('enhance_single', '{{ status.get('file_path')|replace('\\', '/')|e }}'); return false;">
                                                    <i class="bi bi-stars me-2"></i>Enhance
                                                </a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="executeIssueScript('add', '{{ status.get('file_path')|replace('\\', '/')|e }}'); return false;">
                                                    <i class="bi bi-file-plus me-2"></i>Add Blank to End
                                                </a></li>
                                        </ul>
                                    </div>
                                </div>
                                {% elif mapped_path and has_manual %}
                                <!-- Manually marked as owned/skipped - show clear button -->
                                <button class="btn btn-sm btn-outline-dark"
                                    onclick="clearManualStatus('{{ issue.number }}')"
                                    title="Clear {{ manual.status }} status">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% else %}
                                <!-- Not found - show search with mark dropdown -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary"
                                        data-series="{{ series.name }}"
                                        data-issue="{{ issue.number }}"
                                        onclick="searchGetComics(this.dataset.series, this.dataset.issue)"
                                        title="Search GetComics">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    {% if mapped_path %}
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split"
                                        data-bs-toggle="dropdown" aria-expanded="false" title="Mark issue">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                        <li><a class="dropdown-item" href="#"
                                                onclick="markIssue('{{ issue.number }}', 'owned'); return false;">
                                                <i class="bi bi-bookmark-check me-2"></i>Mark as Owned
                                            </a></li>
                                        <li><a class="dropdown-item" href="#"
                                                onclick="markIssue('{{ issue.number }}', 'skipped'); return false;">
                                                <i class="bi bi-skip-forward-circle me-2"></i>Mark as Skipped
                                            </a></li>
                                    </ul>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center py-3 px-4">
            {% if mapped_path and issue_status %}
            {% set found_count = issue_status.values()|selectattr('found')|list|length %}
            {% set manual_count = manual_status|length if manual_status else 0 %}
            {% set manual_not_found = namespace(count=0) %}
            {% for num in (manual_status.keys() if manual_status else []) %}
            {% if not issue_status.get(num, {}).get('found') %}
            {% set manual_not_found.count = manual_not_found.count + 1 %}
            {% endif %}
            {% endfor %}
            {% set wanted_count = issues|length - found_count - manual_not_found.count %}
            <small>
                <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>{{ found_count }} found</span>
                {% if manual_count > 0 %}
                <span class="mx-2">|</span>
                <span class="text-success"><i class="bi bi-bookmark-check me-1"></i>{{ manual_count }} marked</span>
                {% endif %}
                <span class="mx-2">|</span>
                <span class="text-warning"><i class="bi bi-star-fill me-1"></i>{{ wanted_count }} wanted</span>
            </small>
            {% else %}
            <small></small>
            {% endif %}
            <small class="text-muted">{{ issues|length }} issues indexed</small>
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5 fade-in-up">
        <div class="mb-4">
            <i class="bi bi-journal-x display-1 text-muted opacity-25"></i>
        </div>
        <h3 class="h2 text-muted mb-3">No issues found</h3>
        <p class="text-muted mb-4 lead">Unable to retrieve issues for this series.</p>
        <button onclick="history.back()" class="btn btn-outline-primary btn-lg">
            <i class="bi bi-arrow-left me-1"></i>Back
        </button>
    </div>
    {% endif %}
</div>

<!-- Modals -->

<!-- CBZ Info Modal -->
<div class="modal fade" id="cbzInfoModal" tabindex="-1" aria-labelledby="cbzInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cbzInfoModalLabel">CBZ Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Navigation buttons row -->
                <div id="cbzNavButtons" class="d-flex justify-content-between mb-3" style="display: none !important;">
                    <button type="button" id="cbzPrevBtn" class="btn btn-outline-primary" style="visibility: hidden;">
                        <i class="bi bi-arrow-left"></i> Prev
                    </button>
                    <button type="button" id="cbzNextBtn" class="btn btn-outline-primary" style="visibility: hidden;">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>

                <div id="cbzInfoContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading CBZ information...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of CBZ Info Modal -->

<!-- Mark Issue Modal -->
<div class="modal fade" id="markIssueModal" tabindex="-1" aria-labelledby="markIssueModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markIssueModalLabel">Mark Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="markIssueNumber">
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="markStatus" id="markOwned" value="owned" checked>
                        <label class="btn btn-outline-success" for="markOwned">
                            <i class="bi bi-bookmark-check me-1"></i>Owned
                        </label>
                        <input type="radio" class="btn-check" name="markStatus" id="markSkipped" value="skipped">
                        <label class="btn btn-outline-dark" for="markSkipped">
                            <i class="bi bi-skip-forward-circle me-1"></i>Skipped
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="markNotes" class="form-label">Notes (optional)</label>
                    <input type="text" class="form-control" id="markNotes"
                        placeholder="e.g., In Amazing Spider-Man Omnibus Vol. 1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMarkIssue()">
                    <i class="bi bi-check-lg me-1"></i>Mark Issue
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End of Mark Issue Modal -->

<!-- GCD Series Selection Modal -->
<div class="modal fade" id="gcdSeriesModal" tabindex="-1" aria-labelledby="gcdSeriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gcdSeriesModalLabel">Select Correct Series</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p><strong>Parsed from filename:</strong></p>
                    <ul class="list-unstyled">
                        <li><strong>Series:</strong> <span id="gcdParsedSeries"></span></li>
                        <li><strong>Issue:</strong> <span id="gcdParsedIssue"></span></li>
                        <li><strong>Year:</strong> <span id="gcdParsedYear"></span></li>
                    </ul>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="mb-0"><strong>Please select the correct series from the GCD database:</strong></p>
                        <div class="btn-group" role="group" aria-label="Sort options">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="sortBySeries"
                                onclick="sortGCDSeries('series')">
                                <i class="bi bi-sort-alpha-down me-1"></i>Series
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="sortByYear"
                                onclick="sortGCDSeries('year')">
                                <i class="bi bi-sort-numeric-down me-1"></i>Year
                            </button>
                        </div>
                    </div>
                    <div id="gcdSeriesList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        <!-- Series options will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- End of GCD Series Selection Modal -->

<!-- ComicVine Volume Selection Modal -->
<div class="modal fade" id="comicVineVolumeModal" tabindex="-1" aria-labelledby="comicVineVolumeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="comicVineVolumeModalLabel">Select Correct Volume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p><strong>Parsed from filename:</strong></p>
                    <ul class="list-unstyled">
                        <li><strong>Series:</strong> <span id="cvParsedSeries"></span></li>
                        <li><strong>Issue:</strong> <span id="cvParsedIssue"></span></li>
                        <li><strong>Year:</strong> <span id="cvParsedYear"></span></li>
                    </ul>
                </div>
                <div class="mb-3">
                    <p class="mb-2"><strong>Please select the correct volume from ComicVine:</strong></p>
                    <div id="cvVolumeList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        <!-- Volume options will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- End of ComicVine Volume Selection Modal -->

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="moveErrorToast" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <strong class="me-auto">Rename Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="moveErrorToastBody">
            Rename failed.
        </div>
    </div>
</div>

<!-- Edit CBZ Modal -->
<div class="modal fade" id="editCBZModal" tabindex="-1" aria-labelledby="editCBZModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCBZModalLabel">Editing CBZ File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                    <!-- Inline editing content (cards) will be dynamically loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEditBtn" onclick="saveEditedCBZ()">
                    <i class="bi bi-floppy2-fill"></i> Save
                </button>
                <form action="/save" method="post" id="editInlineSaveForm" style="display: none;">
                    <input type="hidden" name="folder_name" id="editInlineFolderName">
                    <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
                    <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center bg-dark"
                style="overflow: hidden; position: relative;">
                <div id="cropImageContainer"
                    style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
                    <img id="cropImage" src="" alt="Image to crop"
                        style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
                    <div id="cropSelection"
                        style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()"
                    disabled>Confirm Crop</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Free Form Crop Modal -->

<!-- ComicVine URL Modal -->
<div class="modal fade" id="cvInfoModal" tabindex="-1" aria-labelledby="cvInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cvInfoModalLabel"><i class="bi bi-link-45deg"></i> Add CVINFO</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">Enter the Comic Vine Volume ID for this series. This will be saved as a
                    <code>cvinfo</code> file and used to auto-fetch metadata for comics in this folder.
                </p>
                <div class="mb-3">
                    <label for="cvInfoIdInput" class="form-label">Comic Vine Volume ID <span
                            class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="cvInfoIdInput" placeholder="167796" required>
                    <div class="form-text">Example: https://comicvine.gamespot.com/volume/4050-<strong>167796</strong> -
                        the CV_ID is <strong>167796</strong></div>
                </div>
                <div class="mb-3">
                    <label for="metronIdInput" class="form-label">Metron Series ID <span
                            class="text-muted">(optional)</span></label>
                    <input type="text" class="form-control" id="metronIdInput" placeholder="12345">
                    <div class="form-text">If you have a Metron series ID, enter it here to enable Metron metadata
                        fetching.</div>
                </div>
                <input type="hidden" id="cvInfoDirectoryPath">
                <input type="hidden" id="cvInfoPanel">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCVInfo()">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End of ComicVine URL Modal -->

<!-- Update XML Modal -->
<div class="modal fade" id="updateXmlModal" tabindex="-1" aria-labelledby="updateXmlModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateXmlModalLabel">Update ComicInfo.xml</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="updateXmlField" class="form-label">Field to Update</label>
                    <select class="form-select" id="updateXmlField">
                        <option value="Volume">Volume (Year)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="updateXmlValue" class="form-label">Value</label>
                    <input type="text" class="form-control" id="updateXmlValue" placeholder="Enter value" maxlength="4">
                    <div class="form-text" id="updateXmlHint">Enter a 4-digit year (e.g., 2024)</div>
                </div>
                <div class="text-muted small" id="updateXmlFolderInfo">
                    Folder: <span id="updateXmlFolderName"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateXmlConfirmBtn">Update</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Update XML Modal -->

<style>
    .fade-in-down {
        animation: fadeInDown 0.3s ease-out;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-up {
        animation: slideUpFade 0.5s ease-out;
    }

    @keyframes slideUpFade {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- Directory Modal -->
<div class="modal fade" id="directoryModal" tabindex="-1" aria-labelledby="directoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="directoryModalLabel">Select Series Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter buttons -->
                <div id="directory-filter" class="mb-2">
                    <div class="btn-group d-flex flex-wrap gap-1" role="group" aria-label="Directory Filter">
                        <!-- Dynamically inserted buttons go here -->
                    </div>
                </div>
                <p id="current-path-display" class="fw-bold text-primary mb-2">/data</p>
                <ul id="directory-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <!-- Directories will be loaded here dynamically -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectCurrentDirectory()">
                    <i class="bi bi-check-lg me-1"></i>Select This Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Subscribe Modal -->
<div class="modal fade" id="subscribeModal" tabindex="-1" aria-labelledby="subscribeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subscribeModalLabel">
                    <i class="bi bi-bookmark-plus me-2"></i>Subscribe to Series
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Create a folder and map this series to your collection.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Folder Path</label>
                    <input type="text" class="form-control" id="subscribePath">
                    <small class="text-muted">Based on your CUSTOM_MOVE_PATTERN setting</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmSubscribe()" id="subscribeBtn">
                    <i class="bi bi-folder-plus me-1"></i>Create & Map
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GetComics Search Modal -->
<div class="modal fade" id="getcomicsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-search me-2"></i>Search GetComics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="getcomicsQuery" placeholder="Search query..."
                            onkeypress="if(event.key==='Enter')doGetComicsSearch()">
                        <button class="btn btn-primary" onclick="doGetComicsSearch()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div id="getcomicsResults">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search display-4 opacity-25"></i>
                        <p class="mt-2">Enter search query above</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Series data from server
    const seriesData = {{ series_dict| tojson | safe if series_dict else '{}' }};
    const currentMappedPath = {{ mapped_path| tojson | safe if mapped_path else 'null' }};

    // Force refresh from Metron API (bypass cache)
    function forceRefresh() {
        const url = new URL(window.location.href);
        url.searchParams.set('refresh', '1');
        window.location.href = url.toString();
    }

    // Subscribe functionality
    const subscribePattern = '{{ config.CUSTOM_MOVE_PATTERN | default("{publisher}/{series_name}/v{start_year}") }}';
    const dataPath = '{{ config.DATA | default("/data") }}';

    function openSubscribeModal() {
        // Sanitize values so they don't break folder paths
        function sanitizePathSegment(val) {
            return val.replace(/\//g, '-').replace(/:/g, ' -');
        }

        const publisher = sanitizePathSegment(seriesData.publisher?.name || 'Unknown');
        const seriesName = sanitizePathSegment(seriesData.name || 'Unknown');
        // Handle both API field (year_began) and database field (volume_year)
        const startYear = seriesData.year_began || seriesData.volume_year || '';
        // Volume number from Metron API (e.g., 2 -> "v2")
        const volumeRaw = seriesData.volume || seriesData.volume_number || '';
        const volumeNumber = volumeRaw ? 'v' + volumeRaw : '';

        let path = subscribePattern
            .replace('{publisher}', publisher)
            .replace('{series_name}', seriesName)
            .replace('{start_year}', startYear)
            .replace('{volume_number}', volumeNumber);

        // Clean up if placeholders had no value: remove empty parens, brackets, extra spaces
        path = path.replace(/\s*\(\s*\)/g, '').replace(/\s*\[\s*\]/g, '');
        path = path.replace(/\s+/g, ' ').trim();
        // Clean empty path segments (e.g., "Marvel//Spider-Man" -> "Marvel/Spider-Man")
        path = path.replace(/\/+/g, '/');

        // Combine with DATA base path
        const fullPath = dataPath.replace(/\/$/, '') + '/' + path.replace(/^\//, '');

        document.getElementById('subscribePath').value = fullPath;
        new bootstrap.Modal(document.getElementById('subscribeModal')).show();
    }

    async function confirmSubscribe() {
        const path = document.getElementById('subscribePath').value.trim();
        if (!path) return;

        const btn = document.getElementById('subscribeBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
            const resp = await fetch('/api/series/{{ series.id }}/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            });
            const data = await resp.json();

            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-folder-plus me-1"></i>Create & Map';
            }
        } catch (e) {
            alert('Error: ' + e.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-folder-plus me-1"></i>Create & Map';
        }
    }

    // GetComics search functionality
    let currentSearchSeries = '';
    let currentSearchIssue = '';
    let getcomicsModal = null;

    document.addEventListener('DOMContentLoaded', function () {
        const modalEl = document.getElementById('getcomicsModal');
        if (modalEl) {
            getcomicsModal = new bootstrap.Modal(modalEl);
        }
    });

    function searchGetComics(seriesName, issueNumber) {
        currentSearchSeries = seriesName;
        currentSearchIssue = issueNumber;

        const query = `${seriesName} ${issueNumber}`;
        document.getElementById('getcomicsQuery').value = query;

        getcomicsModal.show();
        doGetComicsSearch();
    }

    async function doGetComicsSearch() {
        const query = document.getElementById('getcomicsQuery').value.trim();
        if (!query) return;

        const resultsDiv = document.getElementById('getcomicsResults');
        resultsDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Searching GetComics...</p>
        </div>`;

        try {
            const resp = await fetch(`/api/getcomics/search?q=${encodeURIComponent(query)}`);
            const data = await resp.json();

            if (!data.success) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">${escapeHtmlGC(data.error)}</div>`;
                return;
            }

            if (data.results.length === 0) {
                resultsDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-emoji-frown display-4 opacity-25"></i>
                    <p class="mt-2">No results found</p>
                </div>`;
                return;
            }

            // Sort results - expected match at top
            const sorted = sortResultsGC(data.results, currentSearchSeries, currentSearchIssue);

            resultsDiv.innerHTML = sorted.map((r, idx) => `
            <div class="card mb-2 ${idx === 0 && r.score > 5 ? 'border-success' : ''}">
                <div class="card-body d-flex align-items-center gap-3 py-2">
                    ${r.image ? `<img src="${escapeHtmlGC(r.image)}" style="width:50px;height:75px;object-fit:cover;" class="rounded" onerror="this.style.display='none'">` : '<div style="width:50px"></div>'}
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold text-truncate" title="${escapeHtmlGC(r.title)}">${escapeHtmlGC(r.title)}</div>
                        <small class="text-muted text-truncate d-block">${escapeHtmlGC(r.link)}</small>
                    </div>
                    <button class="btn btn-sm btn-primary flex-shrink-0" onclick="downloadFromGetComics(this, '${escapeHtmlGC(r.link)}', '${escapeJsGC(r.title)}')" title="Download">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
        `).join('');

        } catch (e) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtmlGC(e.message)}</div>`;
        }
    }

    function sortResultsGC(results, seriesName, issueNumber) {
        return results.map(r => {
            let score = 0;
            const title = r.title.toLowerCase();
            const series = seriesName.toLowerCase();

            if (title.includes(series)) score += 10;
            if (title.includes(`#${issueNumber}`) || title.includes(` ${issueNumber} `) || title.endsWith(` ${issueNumber}`)) score += 5;

            return { ...r, score };
        }).sort((a, b) => b.score - a.score);
    }

    async function downloadFromGetComics(btn, pageUrl, title) {
        const filename = title.replace(/[^a-zA-Z0-9\s\-#]/g, '').trim() + '.cbz';

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const resp = await fetch('/api/getcomics/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: pageUrl, filename: filename })
            });
            const data = await resp.json();

            if (data.success) {
                btn.innerHTML = '<i class="bi bi-check"></i>';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                showToastGC('Download queued successfully!', 'success');

                setTimeout(() => {
                    getcomicsModal.hide();
                }, 500);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i>';
                showToastGC('Error: ' + data.error, 'danger');
            }
        } catch (e) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download"></i>';
            showToastGC('Error: ' + e.message, 'danger');
        }
    }

    function escapeHtmlGC(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJsGC(str) {
        return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function showToastGC(message, type) {
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
        }

        const toastId = 'toast-' + Date.now();
        const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${escapeHtmlGC(message)}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', toastHtml);

        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
        toast.show();

        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }
</script>
<script src="{{ url_for('static', filename='js/files.js') }}?v={{ range(1000, 9999) | random }}&t=202502"></script>
<script src="{{ url_for('static', filename='js/series.js') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}