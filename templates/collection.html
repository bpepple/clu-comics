{% extends 'base.html' %}
{% block title %}Browse Library{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/collection.css') }}?v={{ range(1, 10000) | random }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<script>
    // Initial path from URL (e.g., /collection/Marvel -> /data/Marvel)
    // If no URL path specified, check localStorage for saved library selection
    (function () {
        const urlPath = {{ initial_path | default ('') | tojson | safe
    }};
    if (urlPath && urlPath !== '') {
        window.INITIAL_PATH = urlPath;
    } else {
        // Check localStorage for saved library preference
        const savedLibrary = localStorage.getItem('selectedLibrary');
        window.INITIAL_PATH = savedLibrary || '';
    }
    }) ();
</script>
{% endblock %}
{% block content %}
<div class="container-lg mt-4">
    <!-- Header Image Container -->
    <div id="collection-header-image" class="mb-3 d-none"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb" class="flex-grow-1">
            <ol class="breadcrumb mb-0" id="breadcrumb">
                <li class="breadcrumb-item active">Loading...</li>
            </ol>
        </nav>
        <!-- Library Selector -->
        <div class="mx-3" id="librarySelectorContainer" style="display: none;">
            <select class="form-select form-select-sm" id="librarySelector" onchange="switchLibrary(this.value)"
                style="min-width: 150px;">
                <!-- Options populated by JavaScript -->
            </select>
        </div>
        <!-- View Toggle Buttons -->
        <div class="mx-3" id="viewToggleButtons">
            <button class="btn btn-outline-primary btn-sm" id="allBooksBtn" onclick="loadAllBooks()"
                style="display: none;">
                <i class="bi bi-collection"></i> All Books
            </button>
            <button class="btn btn-outline-warning btn-sm" id="missingXmlBtn" onclick="loadMissingXml()"
                style="display: none;">
                <i class="bi bi-file-earmark-x"></i> Missing XML
            </button>
            <button class="btn btn-primary btn-sm" id="folderViewBtn" onclick="returnToFolderView()"
                style="display: none;">
                <i class="bi bi-folder"></i> Collection View
            </button>
        </div>
        <div class="d-flex align-items-center">
            <div class="input-group input-group-sm me-2">
                <label class="input-group-text" for="itemsPerPage">Per page</label>
                <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage(this.value)">
                    <option value="21" selected>20</option>
                    <option value="49">50</option>
                    <option value="98">100</option>
                    <option value="252">250</option>
                </select>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshCurrentView(true, true)" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <!-- Filter Bar -->
    <div class="d-flex flex-wrap flex-md-nowrap gap-2 gap-md-3 mb-3">
        <div id="gridFilterButtons" style="display: none; flex: 1 1 auto;">
            <div class="btn-group btn-group-sm" role="group" aria-label="Filter by first letter">
                <!-- Filter buttons will be dynamically populated by JS -->
            </div>
        </div>
        <div id="gridSearchRow" style="flex: 0 0 auto; width: 100%; max-width: 250px;">
            <!-- Search input will be dynamically populated by JS -->
        </div>
    </div>

    <!-- Dashboard Sections -->
    <div id="dashboard-sections" class="mb-5">
        {% for section in dashboard_sections %}
        {% if section.id == 'library' %}
        <!-- Library Section -->
        <section class="mb-4 dashboard-section" id="library-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0" id="library-header-title"><i class="bi {{ section.icon }} me-2"></i>{{ section.title }}
                </h4>
            </div>
            <!-- Selection Hint -->
            <div id="selectionHint" class="selection-hint" style="display: none;">
                <i class="bi bi-info-circle me-1"></i>
                <span>Ctrl+Click to select files &bull; Shift+Click for range</span>
            </div>
            <div id="file-grid" class="file-grid">
            </div>
            <div id="empty-state" class="text-center py-5" style="display: none;">
                <i class="bi bi-folder2-open display-1 text-muted"></i>
                <p class="lead text-muted mt-3">This folder is empty</p>
            </div>
            <nav id="pagination-controls" aria-label="File browser pagination" class="mt-4" style="display: none;">
                <ul class="pagination justify-content-center" id="pagination-list">
                </ul>
            </nav>
        </section>
        {% elif section.id == 'discover' %}
        <!-- Discover / Recommendations -->
        <section class="mb-4 dashboard-section" id="discoverSection">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi {{ section.icon }} me-2"></i>{{ section.title }}</h4>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshRecommendations()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="position-relative">
                <div id="recommendationsLoading" class="text-center p-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Consulting the Oracle...</p>
                </div>
                <div id="recommendationsPlaceholder" class="text-center p-5 text-muted">
                    <i class="bi bi-lightbulb fs-1 mb-3"></i>
                    <p>Click Refresh to get AI-powered recommendations based on your reading history.</p>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-5 g-3" id="recommendationsGrid">
                </div>
            </div>
        </section>
        {% else %}
        <!-- {{ section.title }} -->
        <section class="mb-4 dashboard-section" {% if section.get('section_html_id') %}
            id="{{ section.section_html_id }}" {% endif %}>
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h4 class="m-0"><i class="bi {{ section.icon }} me-2"></i>{{ section.title }}</h4>
                {% if section.get('view_all_type') == 'link' %}
                <a href="{{ section.view_all_href }}" class="btn btn-sm btn-link text-decoration-none">{{
                    section.view_all_text }}</a>
                {% else %}
                <button class="btn btn-sm btn-link text-decoration-none" {% if section.get('view_all_onclick') %}
                    onclick="{{ section.view_all_onclick }}" {% endif %}>{{ section.view_all_text }}</button>
                {% endif %}
            </div>
            <div class="swiper dashboard-swiper" id="{{ section.swiper_id }}">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <div class="dashboard-card text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </section>
        {% endif %}
        {% endfor %}
    </div>
    <div id="loading-indicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
<!-- Template for Grid Item -->
<template id="grid-item-template">
    <div class="grid-item">
        <div class="thumbnail-container">
            <img src="" alt="" class="thumbnail" loading="lazy">
            <div class="icon-overlay">
                <i class="bi"></i>
            </div>
            <button class="info-button no-propagation" title="CBZ Information">
                <i class="bi bi-info-circle"></i>
            </button>
            <button class="favorite-button no-propagation" title="Add to Favorites" style="display: none;">
                <i class="bi bi-bookmark-heart"></i>
            </button>
            <button class="to-read-button no-propagation" title="Add to To Read" style="display: none;">
                <i class="bi bi-bookmark-plus"></i>
            </button>
            <span class="issue-badge" style="display: none;"><span class="issue-number"></span><i
                    class="bi bi-book read-icon"></i></span>
            <span class="xml-badge" style="display: none;" title="No ComicInfo.xml">
                <i class="bi bi-file-earmark-x fs-6"></i>
            </span>
        </div>
        <div class="item-info d-flex justify-content-between align-items-start mt-2">
            <div class="item-details text-truncate flex-grow-1">
                <div class="item-name text-truncate text-dark" title=""></div>
                <div class="item-meta text-muted small"></div>
            </div>
            <div class="item-actions dropdown ms-2">
                <button class="btn btn-link btn-sm p-0 text-dark no-propagation" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item action-crop" href="#">Crop Cover</a></li>
                    <li><a class="dropdown-item action-remove-first" href="#">Remove 1st Image</a></li>
                    <li><a class="dropdown-item action-edit" href="#">Edit File</a></li>
                    <li><a class="dropdown-item action-rebuild" href="#">Rebuild</a></li>
                    <li><a class="dropdown-item action-enhance" href="#">Enhance</a></li>
                    <li><a class="dropdown-item action-set-read-date" href="#">
                            <i class="bi bi-calendar-check"></i> <span class="set-read-date-text">Set Read Date</span>
                        </a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item action-delete text-danger" href="#"><i class="bi bi-trash"></i>
                            Delete</a></li>
                </ul>
            </div>
        </div>
    </div>
</template>
<!-- Edit CBZ Modal -->
<div class="modal fade" id="editCBZModal" tabindex="-1" aria-labelledby="editCBZModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCBZModalLabel">Editing CBZ File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editInlineContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                    <!-- Inline editing content (cards) will be dynamically loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEditBtn" onclick="saveEditedCBZ()">
                    <i class="bi bi-floppy2-fill"></i> Save
                </button>
                <form action="/save" method="post" id="editInlineSaveForm" style="display: none;">
                    <input type="hidden" name="folder_name" id="editInlineFolderName">
                    <input type="hidden" name="zip_file_path" id="editInlineZipFilePath">
                    <input type="hidden" name="original_file_path" id="editInlineOriginalFilePath">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Free Form Crop Modal -->
<div class="modal fade" id="freeFormCropModal" tabindex="-1" aria-labelledby="freeFormCropModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="freeFormCropModalLabel">Free Form Crop - Click and drag to select area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center bg-dark"
                style="overflow: hidden; position: relative;">
                <div id="cropImageContainer"
                    style="position: relative; display: inline-block; max-width: 100%; max-height: 100%; cursor: crosshair;">
                    <img id="cropImage" src="" alt="Image to crop"
                        style="max-width: 100%; max-height: 90vh; display: block; user-select: none;">
                    <div id="cropSelection"
                        style="position: absolute; border: 3px dashed #ff0000; background-color: rgba(255, 0, 0, 0.1); display: none; pointer-events: none;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCropBtn" onclick="confirmFreeFormCrop()"
                    disabled>Confirm Crop</button>
            </div>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file?</p>
                <div class="alert alert-warning">
                    <strong>File:</strong> <span id="deleteFileName"></span><br>
                    <strong>Size:</strong> <span id="deleteFileSize"></span><br>
                    <strong>Path:</strong> <span id="deleteFilePath" class="text-break"></span>
                </div>
                <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteFile()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Comic Reader Modal -->
<div id="comicReaderModal" class="comic-reader-modal" style="display: none;">
    <div class="comic-reader-overlay"></div>
    <div class="comic-reader-container">
        <!-- Header -->
        <div class="comic-reader-header">
            <div class="comic-reader-title" id="comicReaderTitle">Loading...</div>
            <div class="comic-reader-progress">
                <div class="comic-reader-progress-bar">
                    <div class="comic-reader-progress-fill"></div>
                </div>
                <span class="comic-reader-progress-text">0%</span>
            </div>
            <div class="comic-reader-controls">
                <span class="comic-reader-page-info" id="comicReaderPageInfo">Page 1 of 1</span>
                <button class="btn btn-sm btn-outline-light" id="comicReaderBookmark" title="Save Position">
                    <i class="bi bi-bookmark text-primary"></i>
                </button>
                <button class="btn btn-sm btn-outline-light" id="comicReaderClose" title="Close">
                    <i class="bi bi-x-lg text-light"></i>
                </button>
            </div>
        </div>
        <!-- Swiper -->
        <div class="swiper comic-reader-swiper" id="comicReaderSwiper">
            <div class="swiper-wrapper" id="comicReaderWrapper">
                <!-- Slides will be dynamically added here -->
            </div>
            <!-- Navigation -->
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
        <!-- Next Issue Overlay -->
        <div id="nextIssueOverlay" class="next-issue-overlay" style="display: none;">
            <div class="next-issue-panel">
                <h4>Continue Reading?</h4>
                <div class="next-issue-thumbnail-container">
                    <img id="nextIssueThumbnail" src="" alt="Next Issue">
                </div>
                <p id="nextIssueName" class="next-issue-name">Next Issue Name</p>
                <div class="next-issue-buttons">
                    <button id="nextIssueContinue" class="btn btn-primary">
                        <i class="bi bi-arrow-right-circle me-1"></i>Continue
                    </button>
                    <button id="nextIssueClose" class="btn btn-outline-light text-light">Close</button>
                </div>
            </div>
        </div>
        <!-- Resume Reading Overlay -->
        <div id="resumeReadingOverlay" class="resume-reading-overlay" style="display: none;">
            <div class="resume-reading-panel">
                <h4><i class="bi bi-bookmark-check me-2"></i>Resume Reading?</h4>
                <p id="resumeReadingInfo" class="resume-reading-info">Continue from page 5 of 32?</p>
                <div class="resume-reading-buttons">
                    <button id="resumeReadingYes" class="btn btn-primary">
                        <i class="bi bi-play-fill me-1"></i>Resume
                    </button>
                    <button id="resumeReadingNo" class="btn btn-outline-light">Start Over</button>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <div class="comic-reader-footer">
            <div class="comic-reader-footer-controls">
                <button class="btn btn-sm btn-outline-light zoom-btn" id="zoomOutBtn" title="Zoom Out (Arrow Down)">
                    <i class="bi bi-zoom-out"></i>
                </button>
                <button class="btn btn-sm btn-outline-light zoom-btn" id="zoomInBtn" title="Zoom In (Arrow Up)">
                    <i class="bi bi-zoom-in"></i>
                </button>
                <select class="form-select form-select-sm page-selector" id="pageSelector">
                    <option value="0">Page 1</option>
                </select>
            </div>
        </div>
    </div>
</div>
<!-- CBZ Info Modal -->
<div class="modal fade" id="cbzInfoModal" tabindex="-1" aria-labelledby="cbzInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cbzInfoModalLabel">CBZ Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cbzInfoContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading CBZ information...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of CBZ Info Modal -->
<!-- Missing File Check Results Modal -->
<div class="modal fade" id="missingFileCheckModal" tabindex="-1" aria-labelledby="missingFileCheckModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="missingFileCheckModalLabel">Missing File Check Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="missingFileCheckContent">
                    <!-- Summary Section -->
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-info-circle"></i> Summary
                        </h6>
                        <p class="mb-0" id="missingFileCheckSummary"></p>
                    </div>

                    <!-- File Link Section -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-file-earmark-text"></i> Missing Issues File
                            </h6>
                            <p class="card-text">
                                A detailed list of missing issues has been saved to:
                            </p>
                            <div class="bg-light p-2 rounded mb-2">
                                <code id="missingFileCheckPath"></code>
                            </div>
                            <a href="#" id="missingFileCheckLink" class="btn btn-sm btn-primary" target="_blank">
                                <i class="bi bi-box-arrow-up-right"></i> View File
                            </a>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="alert alert-secondary mt-3 mb-0">
                        <small>
                            <i class="bi bi-lightbulb"></i>
                            This file will remain in the directory for your reference. You can access it anytime by
                            navigating to the folder.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Missing File Check Results Modal -->
<!-- Text File Viewer Modal -->
<div class="modal fade" id="textFileViewerModal" tabindex="-1" aria-labelledby="textFileViewerModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textFileViewerModalLabel">
                    <i class="bi bi-file-earmark-text"></i> <span id="textFileName">Text File</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="textFileContent" class="text-file-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading text file...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Text File Viewer Modal -->
<!-- Set Read Date Modal -->
<div class="modal fade" id="setReadDateModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setReadDateModalTitle">Set Read Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="readDateInput" class="form-label">Select the date you read this comic:</label>
                <input type="date" id="readDateInput" class="form-control">
                <input type="hidden" id="readDateComicPath">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReadDate()">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Set Read Date Modal -->
<!-- Update XML Modal -->
<div class="modal fade" id="updateXmlModal" tabindex="-1" aria-labelledby="updateXmlModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateXmlModalLabel">Update ComicInfo.xml</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="updateXmlField" class="form-label">Field to Update</label>
                    <select class="form-select" id="updateXmlField">
                        <option value="Volume">Volume (Year)</option>
                        <option value="Publisher">Publisher</option>
                        <option value="Series">Series</option>
                        <option value="SeriesGroup">Series Group</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="updateXmlValue" class="form-label">Value</label>
                    <input type="text" class="form-control" id="updateXmlValue" placeholder="Enter value">
                    <div class="form-text" id="updateXmlHint">Enter a 4-digit year (e.g., 2024)</div>
                </div>
                <div class="text-muted small" id="updateXmlFolderInfo">
                    Folder: <span id="updateXmlFolderName"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateXmlConfirmBtn">Update</button>
            </div>
        </div>
    </div>
</div>
<!-- End of Update XML Modal -->
<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="successToastBody">
                Success message
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="errorToastBody">
                Error message
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>
<!-- Bulk Action Bar -->
<div id="collectionBulkActionBar" class="collection-bulk-action-bar" style="display: none;">
    <div class="container-lg d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <span class="text-white fw-bold" id="collectionBulkCount">0 files selected</span>
            <button class="btn btn-sm btn-outline-light" onclick="clearFileSelection()">
                <i class="bi bi-x-lg me-1"></i>Clear
            </button>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="bulkCreateFolder()">
                <i class="bi bi-folder-plus me-1"></i>Create Folder
            </button>
            <button class="btn btn-sm btn-info" onclick="bulkCombineFiles()">
                <i class="bi bi-files me-1"></i>Combine Files
            </button>
            <button class="btn btn-sm btn-danger" onclick="bulkDeleteFiles()">
                <i class="bi bi-trash me-1"></i>Delete Files
            </button>
        </div>
    </div>
</div>
<!-- Collection Folder Name Modal -->
<div class="modal fade" id="collectionFolderNameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="collectionFolderPromptMessage">Enter a name for the new folder:</p>
                <input type="text" class="form-control" id="collectionFolderName" placeholder="Folder name">
                <div class="mt-3">
                    <strong>Files to move:</strong>
                    <ul class="list-group list-group-flush mt-2" id="collectionFolderFileList"
                        style="max-height: 200px; overflow-y: auto;">
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="collectionConfirmFolderBtn">Create & Move</button>
            </div>
        </div>
    </div>
</div>
<!-- Collection Combine Files Modal -->
<div class="modal fade" id="collectionCombineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Combine CBZ Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="collectionCombineName" class="form-label">Output filename</label>
                    <input type="text" class="form-control" id="collectionCombineName" placeholder="Combined filename">
                </div>
                <div id="collectionCombineFileList" class="small text-muted"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="collectionConfirmCombineBtn">Combine</button>
            </div>
        </div>
    </div>
</div>
<!-- Collection Delete Multiple Modal -->
<div class="modal fade" id="collectionDeleteMultipleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Delete Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Are you sure you want to delete <strong
                        id="collectionDeleteCount">0</strong> file(s)?</p>
                <p class="text-danger"><strong>This action cannot be undone!</strong></p>
                <ul class="list-group list-group-flush" id="collectionDeleteFileList"
                    style="max-height: 200px; overflow-y: auto;">
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="collectionConfirmDeleteBtn">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/collection.js') }}?v={{ range(1, 10000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Dashboard Swipers
        const swiperConfig = {
            slidesPerView: 'auto',
            spaceBetween: 15,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            }
        };

        // Initialize all dashboard swipers with the same config
        document.querySelectorAll('.dashboard-swiper').forEach(el => {
            new Swiper(el, swiperConfig);
            // Dashboard visibility is handled by loadDirectory() in collection.js
        });

        // Load saved recommendations on startup
        loadSavedRecommendations();

        // Initialize library selector
        loadLibrarySelector();
    });

    // Library selector functions
    async function loadLibrarySelector() {
        try {
            const response = await fetch('/api/libraries');
            const data = await response.json();

            if (data.success && data.libraries.length > 1) {
                // Only show selector if there are multiple libraries
                const container = document.getElementById('librarySelectorContainer');
                const selector = document.getElementById('librarySelector');

                if (container && selector) {
                    selector.innerHTML = '';

                    // Get currently selected library from localStorage or default to first
                    const savedLibrary = localStorage.getItem('selectedLibrary');

                    data.libraries.forEach(lib => {
                        const option = document.createElement('option');
                        option.value = lib.path;
                        option.textContent = lib.name;
                        if (lib.path === savedLibrary || (!savedLibrary && data.libraries.indexOf(lib) === 0)) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });

                    container.style.display = 'block';

                    // Store libraries for header title lookup
                    window.libraryData = data.libraries;

                    // Update the header title based on current selection
                    const selectedPath = selector.value;
                    if (selectedPath) {
                        updateLibraryHeaderTitle(selectedPath);
                    }
                }
            }
        } catch (e) {
            console.error('Error loading library selector:', e);
        }
    }

    function switchLibrary(path) {
        // Save selection to localStorage
        localStorage.setItem('selectedLibrary', path);

        // Update the library header title
        updateLibraryHeaderTitle(path);

        // Navigate to the new library root
        if (typeof loadDirectory === 'function') {
            loadDirectory(path);
        }
    }

    function updateLibraryHeaderTitle(path) {
        const headerTitle = document.getElementById('library-header-title');
        if (!headerTitle) return;

        // Find the library name from the path
        let libraryName = 'Library';
        if (window.libraryData) {
            const lib = window.libraryData.find(l => l.path === path || path.startsWith(l.path + '/'));
            if (lib) {
                libraryName = lib.name;
            }
        }

        headerTitle.innerHTML = `<i class="bi bi-collection-fill text-primary me-2"></i>${libraryName}`;
    }

    async function loadSavedRecommendations() {
        const grid = document.getElementById('recommendationsGrid');
        const placeholder = document.getElementById('recommendationsPlaceholder');

        try {
            const response = await fetch('/api/recommendations'); // Default GET
            if (response.ok) {
                const data = await response.json();
                if (Array.isArray(data) && data.length > 0) {
                    if (placeholder) placeholder.style.display = 'none';
                    renderRecommendations(data, grid);
                }
            }
        } catch (e) {
            console.warn("Could not load saved recommendations", e);
        }
    }

    function renderRecommendations(data, grid) {
        grid.innerHTML = '';
        data.forEach(rec => {
            const title = rec.title || rec.Series || "Unknown Title";
            const publisher = rec.publisher || rec.Publisher || "";
            const reason = rec.reason || rec.Reason || "Read to find out why!";

            const card = `
                <div class="col">
                    <div class="card h-100 shadow-sm border-0" style="background: var(--card-bg, #fff);">
                        <div class="card-body">
                            <h6 class="card-title text-primary text-truncate" title="${title}">${title}</h6>
                            <h6 class="card-subtitle mb-2 text-muted small">${publisher}</h6>
                            <p class="card-text small" style="font-size: 0.85rem;">${reason}</p>
                        </div>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', card);
        });
    }
    async function refreshRecommendations() {
        const grid = document.getElementById('recommendationsGrid');
        const loading = document.getElementById('recommendationsLoading');
        const placeholder = document.getElementById('recommendationsPlaceholder');

        // Reset UI
        grid.innerHTML = '';
        if (placeholder) placeholder.style.display = 'none';
        loading.style.display = 'block';

        try {
            const response = await fetch('/api/recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Use server-side default settings
            });

            const data = await response.json();

            if (loading) loading.style.display = 'none'; // Hide loading spinner


            if (response.ok) {
                if (!Array.isArray(data) || data.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center text-muted">No recommendations found. Try reading more comics first!</div>';
                    return;
                }

                renderRecommendations(data, grid);
            } else {
                grid.innerHTML = `<div class="col-12 text-center text-danger">Error: ${data.error || 'Failed to get recommendations'}</div>`;
            }
        } catch (error) {
            if (loading) loading.style.display = 'none'; // Hide loading spinner on error
            grid.innerHTML = `<div class="col-12 text-center text-danger">Network Error: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}